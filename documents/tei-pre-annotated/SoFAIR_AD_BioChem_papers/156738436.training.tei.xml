<?xml version="1.0" encoding="UTF-8"?>
<tei xmlns="http://www.tei-c.org/ns/1.0">
    <teiHeader>
        <fileDesc xml:id="_1"/>
        <encodingDesc>
            <appInfo>
                <application version="0.8.1-SNAPSHOT" ident="GROBID" when="2024-06-24T09:34+0000">
                    <ref target="https://github.com/kermitt2/grobid">A machine learning software for extracting information from scholarly documents</ref>
                </application>
            </appInfo>
        </encodingDesc>
    </teiHeader>
    <text xml:lang="en">
        <p>Fully Bayesian multispecies coalescent (MSC) methods like *BEAST estimate species trees from multiple sequence alignments. Today thousands of genes can be sequenced for a given study, but using that many genes with *BEAST is intractably slow. An alternative is to use heuristic methods which compromise accuracy or completeness in return for speed. A common heuristic is concatenation, which assumes that the evolutionary history of each gene tree is identical to the species tree. This is an inconsistent estimator of species tree topology, a worse estimator of divergence times, and induces spurious substitution rate variation when incomplete lineage sorting is present. Another class of heuristics directly motivated by the MSC avoids many of the pitfalls of concatenation but cannot be used to estimate divergence times. To enable fuller use of available data and more accurate inference of species tree topologies, divergence times, and substitution rates, we have developed a new version of *BEAST called 
            <rs type="software">StarBEAST2</rs>. To improve convergence rates we add analytical integration of population sizes, novel MCMC operators and other optimizations. Computational performance improved by 13.5Â and 13.8Â respectively when analyzing two empirical data sets, and an average of 33.1Â across 30 simulated data sets. To enable accurate estimates of per-species substitution rates, we introduce species tree relaxed clocks, and show that 
            <rs type="software">StarBEAST2</rs> is a more powerful and robust estimator of rate variation than concatenation. 
            <rs type="software">StarBEAST2</rs> is available through the 
            <rs type="software">BEAUTi</rs> package manager in 
            <rs type="software">BEAST</rs>
            <rs type="version">2.4</rs> and above.
        </p>
        <p>The throughput of sequencing technologies has improved remarkably over the past two decades culminating in next generation sequencing (NGS), and it is now feasible to sequence whole or partial genomes or transcriptomes for phylogenetic studies (Lemmon and Lemmon 2013). NGS produces hundreds or thousands of phylogenetically useful loci (see e.g., Blom et al. 2016) with potentially millions of sites spread across a data set of multiple sequence alignments.</p>
        <p>Although NGS offers hundreds or thousands of loci at relatively low cost, making accurate inferences from the enormous amount of data produced is particularly challenging. In the case of *BEAST, a fully Bayesian method of species tree inference which implements a realistic and robust evolutionary model in the multispecies coalescent (MSC; Degnan andRosenberg 2009, Heled andDrummond 2010), it becomes exponentially slower as the number of loci in an analysis is increased. This scaling behavior causes *BEAST to become intractably slow after a certain number of loci (the exact number will depend on other parameters of the data set, see Ogilvie et al. 2016). Given the current challenges of using large phylogenomic data sets with *BEAST there have been three broad alternatives available to researchers; concatenate sequences from multiple loci, use heuristic methods statistically consistent with the MSC, or choose a tractable subset of loci to use with a fully Bayesian method like *BEAST, BEST (Liu 2008), or BPP (Yang 2015).</p>
        <p>Using maximum likelihood phylogenetic methods to infer a species tree based on concatenated sequences will return the single tree that best fits the combined sequence alignment according to the phylogenetic likelihood function (Felsenstein 1981). Popular maximum-likelihood concatenation methods include 
            <rs type="software">RAxML</rs>, 
            <rs type="software">PAML</rs>, and 
            <rs type="software">PhyML</rs> (Stamatakis 2014, Yang 2007, Guindon et al. 2010). Bayesian methods, such as 
            <rs type="software">ExaBayes</rs> and 
            <rs type="software">BEAST</rs> (Aberer et al. 2014, Drummond andRambaut 2007), will instead return a distribution of trees which are probable given the combined sequence alignment, a set of priors, and the same likelihood function. Recent results show that likelihood-based concatenation can be counterproductive, producing statistically inconsistent results which assign high confidence to incorrect nodes due to model misspecification (Liu et al. 2015). In the so-called "anomaly zone" of short branch lengths, the most probable gene tree topology will be different from the species tree, and estimated tree topologies will likely differ from the true species tree topology (Degnan andRosenberg 2006, Kubatko andDegnan 2007).
        </p>
        <p>ß The Author 2017. Published by Oxford University Press on behalf of the Society for Molecular Biology and Evolution. This is an Open Access article distributed under the terms of the Creative Commons Attribution License (http://creativecommons. org/licenses/by/4.0/), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</p>
        <p>Likelihood-based concatenation has been shown to produce systematic errors when estimating branch lengths, including overestimation of divergence times. Because some time is required for genes to coalesce looking backwards from a speciation event, the expected molecular distance between two species is greater than if coalescent events occurred simultaneously with the speciation event. This leads concatenation to overestimate the divergence times across a species tree in proportion to effective population size (Arbogast et al. 2002, Ogilvie et al. 2016).</p>
        <p>Incomplete lineage sorting (ILS) also causes systematic errors in estimated branch lengths when using concatenation. When a gene tree topology is discordant with the species tree topology, then the gene tree will contain one or more branches that define splits not occurring in the species tree. If a substitution occurs on one of these discordant gene tree branches, the resulting site pattern would define a homoplasy on the species tree, implying multiple substitutions. This effect has been termed "substitutions produced by ILS" (SPILS) and causes concatenation to overestimate the lengths of specific branches and underestimate the lengths of others, which produces apparent substitution rate variation where none exists (Mendes and Hahn 2016). For all the above reasons, trees inferred using concatenation are therefore not a reliable approximation of the species tree in terms of branch lengths or topology.</p>
        <p>As an alternative to concatenation for use with phylogenomic data, heuristic methods which do not perform phylogenetic likelihood calculations but are statistically consistent with the MSC have been developed. These include summary methods which utilize distributions of estimated gene tree topologies as input, such as the rooted triplet method MP-EST (Liu et al. 2010) and the quartet method ASTRAL (Mirarab et al. 2014a). Another quartet method is SVDquartets, which utilizes single-nucleotide polymorphism (SNP) matrices (Chifman and Kubatko 2014). Recent results show that MP-EST should be used with caution as it is sensitive to gene tree errors (Mirarab andWarnow 2015, Xi et al. 2015). At low levels of ILS, MP-EST is less accurate than likelihood-based or neighbor-joining concatenation at inferring topologies, and even at high levels of ILS it may be no more accurate than concatenation (Ogilvie et al. 2016). No available heuristic method is both statistically consistent and can infer branch lengths in expected substitutions or calendar units. Therefore, heuristic methods cannot be reliably used to estimate divergence times. If concatenation is used to estimate branch lengths or divergence times for a species tree topology estimated by another heuristic method, then those estimates will be unreliable for the same reasons as pure concatenation.</p>
        <p>An issue specific to summary methods occurs when the assumption of no recombination within loci is substantially violated because overly long loci are used (Gatesy and Springer 2013). To resolve larger and deeper species trees using summary methods, longer and more informative loci may be required to infer more accurate gene trees. However the larger and deeper a tree, the more recombination events will have occurred. The use of longer loci and the higher incidence of recombination will both increase the risk of recombination occurring within loci, which has been dubbed the "recombination ratchet" (Springer and Gatesy 2016).</p>
        <p>As an alternative to increasing locus length, fully Bayesian MSC methods like *BEAST infer more accurate gene trees by sharing information between loci through the species tree (Szo ¨ll} osi et al. 2015). In this way very accurate species trees can be estimated using only weakly informative loci, which may not be possible using MP-EST (Xu and Yang 2016). To avoid the recombination ratchet summary methods can use naı ¨vely binned subsets of gene trees estimated by *BEAST (Zimmermann et al. 2014), or statistically binned subsets of genes trees estimated by concatenation (Mirarab et al. 2014b). Statistical binning has been criticized as statistically inconsistent (Liu and Edwards 2015), and for either binning method the resulting species trees still cannot be used for molecular dating.</p>
        <p>With the aim of improving the computational performance of fully Bayesian MSC inference of species trees, we have developed an upgrade to *
            <rs type="software">BEAST-StarBEAST2</rs>-which is available as a package for BEAST 2 (Bouckaert et al. 2014). By improving computational performance 
            <rs type="software">StarBEAST2</rs> enables the use of more loci, which will improve the precision of estimated parameters and provide an alternative to concatenation. We have also developed and include in 
            <rs type="software">StarBEAST2</rs> new MSC relaxed clock models to enable accurate inference of per-species substitution rates.
        </p>
        <p>Markov Chain Monte Carlo (MCMC) methods like *BEAST jointly integrate over many parameters by proposing small changes at each step to eventually produce a probability distribution over all random variables. From a researcher's perspective,somerandomvariablesmaybe"nuisance" parameters not of scientific interest. For example species tree topology and divergence times may be of interest, but not effective population sizes. For tractable parameters, an analytic solution will integrate over the entire range of values at each MCMC step, and may be faster than MCMC integration. However explicit estimates will not be produced so this approach is suitable only for nuisance parameters. Among-site rate variation is already integrated out at each step; the likelihood of each site is calculatedforallpossiblediscretegammaratecategoriesateachstep, so individual site rates are not estimated (Yang 1994).</p>
        <p>Analytical integration of constant per-branch population sizes was first implemented as part of BEST (Liu et al. 2008), and is described in detail by Jones (2017). The analytic solution, which we have added to StarBEAST2, uses an inverse gamma conjugate prior for population sizes. By default StarBEAST2 fixes the shape of the distribution a ¼ 3 and only estimates the mean of the distribution l, which is proportional to the scale parameter b:</p>
        <p>In this special case where a ¼ 3, the standard deviation is identical to the mean: Ogilvie et al. . doi:10.1093</p>
        <p>The coefficient of variation c v ¼ r=l of the prior distribution for effective population sizes is therefore 1.</p>
        <p>One approach to improving the performance of MSC analyses which simultaneously estimate gene and species trees (such as *BEAST) is to develop MCMC operators which propose coordinated changes to both the species tree and the gene trees in the same step. Yang and Rannala (2014) introduced a Metropolis-Hastings (MH;Metropolis et al. 1953, Hastings 1970) operator which makes nearest-neighbor interchange (NNI) changes to the species tree topology, and simultaneously makes changes to gene tree topologies which preserve compatibility of the gene trees within the proposed species tree. Later, both Jones (2017) and Rannala and Yang (2017) introduced more general coordinated operators which make subtree prune and regraft (SPR) changes to the species tree. We have reimplemented these coordinated NNI and SPR moves in 
            <rs type="software">StarBEAST2</rs> as a single new operator called "CoordinatedExchange." Rannala and Yang (2017) also describe a proposal distribution which favors topological changes on shorter branches as well as less radical changes in topology. 
            <rs type="software">StarBEAST2</rs> implements a simpler proposal distribution but still favors less radical changes by applying adjustable proposal probability weights to (less radical) NNI moves and (more radical) SPR moves.
        </p>
        <p>A novel class of coordinated Metropolis operators was introduced by Jones (2017), which pick at random a nonroot nonleaf species tree node S with an existing height of t(S). A new height t 0 ðSÞ is chosen from a uniform distribution with lower and upper bounds D and U. The height of the species tree node and the heights of subtrees of gene tree nodes (termed "connected components") are all shifted by the amount g ¼ t 0 ðSÞ À tðSÞ.</p>
        <p>The D and U bounds limit the minimum and maximum values of g to those which do not require modifying the topology of the gene tree or of the species tree, and the algorithm to determine those bounds is given by Jones (2017). The species tree root node is excluded because there is no natural upper bound in that case. As long as the connected components are chosen with reference only to the topology of the species tree, the topology of the gene trees, and the mapping of sampled individuals to species, operators of this class are symmetric.</p>
        <p>We have developed a new operator called "CoordinatedUniform" that belongs to this general class but has not been implemented before. Individuals from extant species which descend from a species tree node, or are directly descended from a gene tree node, are referred to here as "descendant individuals." The gene tree nodes s selected by this operator to be shifted in height are all those for which:</p>
        <p>(1) At least one descendant individual of s is also a descendant individual of the left child of S.</p>
        <p>(2) At least one descendant individual of s is also a descendant individual of the right child of S.</p>
        <p>(3) All descendent individuals of s are also descendent individuals of S.</p>
        <p>An example of how gene tree nodes are selected and node heights shifted is given in Supplementary Material online.</p>
        <p>We have also developed a new adaptive MH (Andrieu and Thoms 2008) operator called "CoordinatedExponential" which changes the height of the species tree root node and the height of connected components by an amount g. The gene trees nodes to be shifted are chosen using identical criteria as for CoordinatedUniform. Because this operator changes the height of the root node, a different method must be used to pick g compared with Coordinated Uniform.</p>
        <p>First, the lower bound D is identified in the same way as for CoordinatedUniform and as described in Jones (2017). The difference between D and the current root height is referred to as x, and a new random value x 0 is chosen from an exponential distribution. The value of x 0 À x is then used for g. The median of the exponential distribution is adaptively modified over the course of an MCMC chain to equal the posterior expectation of x.</p>
        <p>Because the proposal distribution for a new species tree root height is independent of the current height, the Hastings ratio which is usually qðx 0 ; xÞ=qðx; x 0 Þ (Hastings 1970) can be simplified to pðxÞ=pðx 0 Þ. The natural logarithm of the Hastings ratio may then be derived from the respective probability densities of x and x 0 drawn from an exponential distribution with the rate k:</p>
        <p>À ln e Àkx 0 (4)</p>
        <p>The overall rate of evolution occurring at a given locus within a species will be influenced by the nature of the particular gene and also by the natural history of the particular species. For a given gene, the average substitution rate may depend on the effects of selection such as the accelerated molecular evolution of sex-biased genes in Arabidopsis thaliana (Gossmann et al. 2014), and on within-genome variation in mutation rate (Baer et al. 2007). For a given species, the average substitution rate is correlated with a multitude of traits including metabolic rate, body size, and fecundity, although causal relationships are difficult to pin down (Bromham 2011). Unsurprisingly in light of the above, empirical analysis has shown that two major factors contributing to rate StarBEAST2 . doi:10.1093/molbev/msx126</p>
        <p>variation among gene branches are the per-gene rate and the per-species rate (Rasmussen and Kellis 2007).</p>
        <p>Because variation is expected in the nature of different genes and species, and therefore variation is also expected in the average substitution rate of different genes and species, MSC models should take both per-gene and per-species rate variation into account. *BEAST can accommodate both types of rate variation using gene tree relaxed clock models (e.g., see Berv andPrum 2014, Lambert et al. 2015). This involves estimating per-branch substitution rates separately for each branch of each gene tree. While gene tree relaxed clocks may accommodate variation in substitution rates between species, they do not produce estimates of species branch rates. To enable accurate inference of species branch rates, we have developed a new species tree relaxed clock model.</p>
        <p>The challenge of applying a relaxed clock to the species tree is that phylogenetic likelihood calculations require branch rates for each branch of each gene tree. Our clock model computes those rates using the total expected number of substitutions REðSÞ accumulated along the entire length of a gene tree branch. In each species tree branch, substitutions are expected to be accumulated at the mean clock rate of the gene tree c, multiplied by the length of time L spent traversing the species tree branch, multiplied by the rate R of the corresponding species tree branch. Typical nuclear substitution rates for mammals are around 10 À3 substitutions per site per million years (Phillips et al. 2009).</p>
        <p>The gene tree branch rates r can then be derived by dividing the total expected number of substitutions by the total length of that branch l. The gene tree branch rates for the illustrated example (fig. 1 andtable 1) are therefore:</p>
        <p>The new species tree relaxed clock model is available in 
            <rs type="software">StarBEAST</rs>
            <rs type="version">2</rs>. Branch rate models that can be used with a species tree relaxed clock currently include the wellestablished uncorrelated log-normal (UCLN) and uncorrelated exponential (UCED) models (Drummond et al. 2006), as well as the newer random local clock model (Drummond and Suchard 2010). The current species tree relaxed clock implementation estimates-separately for each species tree branch-a single relative rate. However, it is possible to imagine a further relaxed model that estimates-again separately for each species tree branch-hyperparameters for a prior distribution on substitution rates. This would enable gene tree branch rates to be guided by the species tree, but still allow some difference in response between genes.
        </p>
        <p>New methods must be shown to be correct implementations of the target model. One way to accomplish this for MCMC methods is to estimate parameters from a prior distribution using the MCMC kernel, and to also draw independent samples from the same distribution by simulation. The resulting parameter distributions should be identical if the implementation is correct. We used this method to test the correctness of the novel features in 
            <rs type="software">StarBEAST</rs>
            <rs type="version">2</rs>; analytical population size integration, coordinated operators, and species tree relaxed clocks. Simulated and 
            <rs type="software">StarBEAST</rs>
            <rs type="version">2</rs> distributions were identical for species and gene tree topologies (supplementary figs. S1 and S2, Supplementary Material online), species and gene tree node heights (supplementary figs. S3 and S4, Supplementary Material online), and for gene tree branch rates (supplementary figs. S5 and S6, Supplementary Material online). This combination of results supports the correctness of the 
            <rs type="software">StarBEAST</rs>
            <rs type="version">2</rs> implementation.
        </p>
        <p>When using concatenation to infer a species tree, SPILS causes apparent substitution rate variation. However in an ultrametric (time tree) framework like BEAST, branch lengths are constrained so that terminal species begin at time zero. We FIG. 1. Two-species phylogeny used to illustrate species tree relaxed clocks. There are two extant species "A" and "B", and one ancestral species "AB." Within the species tree there is a single gene tree with extant individuals "a" and "b." The single speciation event occurs at time T1, and the single coalescence event occurs at time t1. Gene tree rates are computed according to table 1.</p>
        <p>hypothesized that if a relaxed clock is used with concatenation in an ultrametric framework, SPILS will be absorbed as faster substitution rates for lineages that would be lengthened by SPILS in a nonultrametric framework.</p>
        <p>In an ultrametric framework with a strict clock and no external (e.g., fossil, biogeographical or known clock rate) calibrations, the substitution rate of each branch is set to 1. This ensures that 1 unit of time is equivalent to 1 expected substitution. Using a relaxed clock with no external calibrations the substitution rate of each branch can vary, but the expectation of the mean rate of all branches is 1, preserving the relationship of 1 unit of time ¼ 1 expected substitution. Therefore, when SPILS causes the rates of some branches to be faster than 1, the rates of some other branches will be slower than 1 to keep the expected mean constant.</p>
        <p>We used 
            <rs type="software">BEAST</rs> concatenation and 
            <rs type="software">StarBEAST2</rs> with a species tree relaxed clock to infer the branch lengths and substitution rates of simulated species trees with the topology ((((A,B),C),D),E), using sequence alignments simulated using a strict clock. Gene tree discordance will increase the estimated length of A, B, and C branches for these species trees (Mendes and Hahn 2016), and as hypothesized substitution rates for A and B branches inferred using concatenation were biased towards being faster than the true rate of 1 (fig. 2). Estimated substitution rates for the C branch were more variable, and could be faster or slower than 1. Substitution rates estimated for the D and E branches were biased towards being slower than 1, presumably to balance the mean rate. Concatenation also overestimated the lengths of tip branches, another known bias when using concatenation to infer a species tree (Ogilvie et al. 2016). No biases were observed for the branch rates or lengths estimated using 
            <rs type="software">StarBEAST2</rs> (fig. 2).
        </p>
        <p>A number of estimated branch rates had 95% credible intervals that excluded the true rate of 1 when using concatenation. If a study is testing whether substitution rates vary across a species tree, those branch rates could be erroneously interpreted as faster or slower than average. In our simulations, the clock rate of the D branch would be inferred as slower than average in 37 out of 96 replicates (supplementary fig. S7, Supplementary Material online), despite the sequence data being simulated using a strict clock. When applying the same 95% credible intervals to branch lengths, the true simulated length was excluded with just two exceptions for all tip branches across all replicates using concatenation (supplementary fig. S8, Supplementary Material online). In contrast, no erroneous results would be inferred for branch rates given the same data using 
            <rs type="software">StarBEAST</rs>
            <rs type="version">2</rs>, and out of the 768 total simulated non-root branch lengths, only five erroneous results would be inferred (supplementary figs. S7 and S8, Supplementary Material online). Mendes and Hahn (2016) demonstrated that SPILS causes systematic bias when estimating branch lengths, and we show that this translates into systematic bias when estimating perbranch substitution rates. Because the bias is caused by ILS which is a function of population sizes and branch lengths, there is no reason to expect that large trees with varying population sizes and branch lengths would be any less biased.
        </p>
        <p>To characterize the performance of coordinated operators, methods of population size integration and relaxed clocks, we tested 
            <rs type="software">StarBEAST2</rs> using empirical and simulated sequence data. The empirical data set used for this analysis is from the North American chorus frog genus Pseudacris, and was originally collected and analyzed by Barrow et al. (2014) A key metric of phylogenies that can be used to judge whether it is necessary to employ MSC models is the average branch length in coalescent units ðb ¼ sð2N e Þ À1 Þ. In this study N e will always refer to the effective population size of diploid individuals. Given short branch lengths, likelihoodbased or neighbor-joining concatenation is unable to infer accurate species trees regardless of the number of loci used, but for long branch lengths, concatenation is approximately as accurate as *BEAST (Ogilvie et al. 2016). Indeed concatenation can be considered a special case of the MSC as the models converge when gene trees are identical to the species tree (Liu et al. 2015). Using 
            <rs type="software">StarBEAST2</rs>, the average branch length within this genus was estimated to be 2.81 coalescent units. This is an intermediate average length compared with the shallow simulations analyzed by Ogilvie et al. (2016) which had a shorter average length of 1.08 coalescent units.
        </p>
        <p>Each replicate of each Pseudacris empirical analysis used the same sequence data, and the true species tree topology, dates and rates were not known with certainty. For performance results more generally applicable than a single empirical system, and to measure the coverage and accuracy of StarBEAST2 inference, we created a simulated data set of 30 replicates. A unique species tree was simulated for each replicate, and gene trees and locus sequences were simulated according to the MSC.</p>
        <p>We simulated 26 nuclear loci from 21 extant species with two individual haplotypes per species, very similar to the empirical data set size. The simulation parameters, including the birth rate, death rate and population sizes, were also chosen to be similar to estimated Pseudacris parameters. The simulated data set had an average branch length of 2.99 coalescent units, so the relative accuracy of MSC models compared with concatenation should be comparable with empirical systems like Pseudacris.</p>
        <p>To determine which configuration of new features would achieve the best performance, we ran 
            <rs type="software">StarBEAST</rs>
            <rs type="version">2</rs> using different combinations of operators, methods of population size integration and clock models. To measure convergence both effective sample size (ESS) per hour and ESS per million states were computed for each independent chain. ESS per hour can be used to calculate the total time required for a converged chain (nominally where ESS equals or exceeds 200), and reflects how effectively operators explore the space of trees and parameters, as well as the computational time required by each operator proposal and likelihood calculation. In contrast, ESS per million states reflects only the exploration of tree and parameter space independently of calculation times. A variety of statistics were recorded for each analysis (supplementary tables S2-S7, Supplementary Material online), and for each replicate the slowest ESS rate out of all statistics recorded for that individual chain was used for all subsequent analyses.
        </p>
        <p>Multiple linear regressions with log transformed ESS rates as the response variables were used to measure the effect of coordinated topology changing operators, coordinated node height changing operators, and the method of population size integration. Each additional feature was treated as a binary indicator variable so that we could quantify the relative performance as a percentage by exponentiating the coefficient for each addition (table 2).</p>
        <p>Coordinated topology operators consistently and significantly reduced ESS per hour, but had no significant effect on ESS per million states (table 2), suggesting that coordinated topology operators are no more effective than naı ¨ve operators at proposing new states. A decrease in the number of states per hour (supplementary fig. S9, Supplementary Material online) shows that they are more computationally expensive than naı ¨ve operators, and explains the negative effect on ESS per hour.</p>
        <p>Coordinated height changing operators consistently and significantly increased ESS per hour and per million states, however the degree of improvement depended on the clock model (fig. 3). For strict clock analyses the increase in ESS per hour was modest at 1.2 and 1.37 times for empirical and simulated data, respectively, whereas for species tree relaxed clocks the increase was 4.99 and 9.27 times, respectively (table 2). The difference in species tree relaxed clock performance suggests that coordinated height changing operators are necessary for practical implementations of that model.</p>
        <p>Analytical population size integration significantly improved ESS per hour and per million states performance in all cases, with the exception of gene tree relaxed clocks applied to the Pseudacris data set (table 2).</p>
        <p>Even with new operators and analytical population size integration, the ESS per hour rates for species tree relaxed clocks were slower than for other clock models (fig. 3). One (Giarla and Esselstyn 2015). This data set consists of 1112 loci sampled from a total of 19 individuals, which belong to nine extant lineages. Again multiple statistics were recorded to compute ESS rates for each replicate.</p>
        <p>Our simulation study confirmed that StarBEAST2 is many times faster than *BEAST (fig. 4). For simulated data, the average log convergence rate of StarBEAST2 with gene tree relaxed clocks was 5.54 lnðESS=hourÞ. This compares to 2.04 using *BEAST, an increase in performance of expð5:54 À2:04Þ ¼ 33:1 times (supplementary table S2, Supplementary Material online). In fact, StarBEAST2 was exp ð4:18 À 2:04Þ ¼ 8:5 times faster at analyzing 52 loci than *BEAST was when analyzing 26.</p>
        <p>
            <rs type="software">StarBEAST</rs>2 was an order of magnitude faster when analyzing either empirical data set. For gene tree relaxed clock reanalyses of Pseudacris, the difference was expð3:98 À 1:38Þ ¼ 13:5 times. For 50-locus Crocidura reanalyzes, it was expð2:79 À 0:17Þ ¼ 13:8 times (supplementary tables S4 and S6, Supplementary Material online).
        </p>
        <p>The ESS per hour convergence of species tree relaxed clocks was lower than for gene tree relaxed clocks. When applying 
            <rs type="software">StarBEAST2</rs> to simulated data, gene tree relaxed clocks were expð5:54 À 3:71Þ ¼ 6:2 times faster than using species tree relaxed clocks (supplementary table S2, Supplementary Material online). The difference was much smaller for empirical data; for Pseudacris reanalyses gene tree relaxed clocks were expð3:98 À 3:44Þ ¼ 1:7 times faster, and for Crocidura they were expð2:79 À 2:12Þ ¼ 2:0 times faster (supplementary tables S4 and S6, Supplementary Material online). In all three cases, species tree relaxed clocks using 
            <rs type="software">StarBEAST2</rs> were still faster than gene tree relaxed clocks using *BEAST (fig. 4).
        </p>
        <p>The increased performance of StarBEAST2 will enable researchers to analyze sequence data more quickly and</p>
        <p>Bayesian methods like 
            <rs type="software">StarBEAST</rs>2 produce both point estimates and credible intervals of inferred parameters. Ideally the point estimates will have low error, and the credible intervals will cover the corresponding true values. For well calibrated Bayesian methods, a 95% credible interval will include the true value 95% of the time. Using a species tree relaxed clock with 
            <rs type="software">StarBEAST</rs>2 improved the coverage of branch length credible intervals (fig. 5A,B), but even when using a strict clock most simulated tip and internal branch lengths were within the corresponding credible intervals. This suggests that a strict clock model may be sufficient for studies using 
            <rs type="software">StarBEAST</rs>2 where substitution rate variation is not of direct interest. When using a strict clock with concatenation most internal branch lengths were outside the credible interval, but when using a relaxed clock were usually within the credible interval (fig. 5B). However even when using a relaxed clock, true tip branch lengths were usually outside the credible intervals inferred by concatenation (fig. 5A).
        </p>
        <p>Point estimates made by *BEAST and StarBEAST2 of both tip and internal branch lengths were more accurate than those made by concatenation (fig. 5C,D). The inaccuracy of tip branch lengths inferred using concatenation was driven by a strong bias towards overestimating tip branch lengths. For some replicates, the sum of estimated tip branch lengths was more than double the sum of simulated tip branches lengths (fig. 5E). Relatively little overestimation of internal branch lengths was observed when using concatenation (fig. 5F).</p>
        <p>Biased tip branch lengths are important because many published phylogenies show evidence of a slowdown in diversification rate (Moen and Morlon 2014). If the ages of extant species are overestimated, this will artificially reduce the number of recent speciation events, mimicking a slowdown. We suggest that accurate inference of changing diversification rates requires species trees inferred by fully Bayesian MSC methods like 
            <rs type="software">StarBEAST</rs>
            <rs type="version">2</rs>.
        </p>
        <p>Using unphased sequences with ambiguity codes for heterozygous sites improved the accuracy of concatenation by reducing the bias in tip lengths to less than 40% (supplementary fig. S10, Supplementary Material online). Ambiguity codes are treated by most phylogenetic methods (including BEAST) as base call uncertainty, indicating the nucleotide at a given site could be one of several possibilities. When used with unphased sequences, they actually indicate the presence of two nucleotides simultaneously, which is therefore a model violation. Using concatenation to analyze unlinked loci is also a model violation, but in the region of parameter space investigated by this simulation study the two errors may partially cancel out.</p>
        <p>We measured the coverage of species tree topologies and used the rooted Robinson-Foulds distance metric to measure the error associated with the maximum clade credibility (MCC) topology point estimates. As with branch lengths, using a relaxed clock with concatenation or a species tree relaxed clock with 
            <rs type="software">StarBEAST</rs>2 improved coverage. Regardless of clock model the coverage of concatenation was low; in &lt;50% of replicates was the simulated topology in the credible set (fig. 6A).
        </p>
        <p>In terms of error rates, using 130 loci was similar to StarBEAST2 using 26 loci (fig. 6B). Using species tree relaxed clocks with StarBEAST2 was slightly more accurate than using strict clocks, but relaxed clocks did not improve the accuracy of concatenation (fig. 6B). Unlike branch lengths, topological</p>
        <p>Although the convergence of species tree relaxed clock analyses took longer than for gene tree relaxed clocks in StarBEAST2, species tree relaxed clocks enable inference of species branch rates within an MSC framework. To gauge the accuracy of estimated branch rates, we used simple linear regressions with the true rate of each simulated branch as the explanatory variable, and the posterior expectation of the rate of that branch (conditional on the corresponding clade being monophyletic in the posterior samples) as the response variable. If all estimates are equally proportional to the truth, then the R 2 coefficient of determination will equal 1. There are intrinsic limits to our ability to estimate substitution rates, namely that branch length is confounded with substitution rate (Thorne and Kishino 2002).</p>
        <p>For analyses of simulated data using 26 loci, the R 2 using StarBEAST2 was 0.39 and by doubling the number of loci to 52 was increased to 0.43. In contrast, the R 2 when using concatenation with 26 loci was 0.26 and even after increasing the number of loci to 130 it was only 0.33, in either case worse than StarBEAST2 using 26 loci (fig. 7). StarBEAST2 is clearly superior to concatenation at inferring branch rates.</p>
        <p>Concatenation is an even worse estimator of branch rates when using unphased sequences with ambiguity codes for heterozygous sites. When applying concatenation to either 26 StarBEAST2 . doi:10.1093/molbev/msx126</p>
        <p>or 130 loci, R 2 was very weak at 0.12 regardless of the number of loci (supplementary fig. S12, Supplementary Material online).</p>
        <p>When estimating divergence dates and substitution rates, the choice is often between using a subset of available loci with a fully Bayesian MSC method, or all available loci with concatenation. Researchers have often opted for the second choice, but we have shown that concatenation may not accurately estimate species ages or per-species substitution rates, even for trees of intermediate branch lengths.</p>
        <p>For all StarBEAST2, *BEAST and concatenation analyses, the version of BEAST used was 2.4.4. For all simulations, the version of biopy (Heled, unpublished data) used was 0.1.9. 
            <rs type="software">Scripts</rs> used to perform all analyses will be available on GitHub (
            <rs type="url">https://github.com/genomescale/starbeast2-manuscript/ tree/master/scripts</rs>; last accessed April 20, 2017).
        </p>
        <p>Simulated trees were generated using biopy, and trees sampled from a prior distribution were generated using 
            <rs type="software">StarBEAST2</rs> with all new features enabled. This included analytical integration of population sizes, coordinated tree topology and node height changing operators, and a species Estimates species tree branch rates using BEAST concateversus 
            <rs type="software">StarBEAST2</rs>. Estimated rates are the posterior expectations of each branch rate from each replicate. Root branch rates, which were fixed at 1, were excluded. In blue are simple linear regression lines of best fit, and in red are the y ¼ x lines showing a perfect relationship between estimates and truth. N ¼ 30. tree relaxed clock. 100,000 species trees were simulated, one gene tree was simulated per species tree with a rate of 0.5, and a second gene tree was simulated per species tree with a rate of 2.0. 100,000 species trees, 100,000 half rate gene trees and 100,000 double rate gene trees were sampled from the prior at a rate of one every 1000 after a 10% burn-in period.
        </p>
        <p>Identical parameters were used for the simulation and for the StarBEAST2 run including the prior distributions. We fixed the number of species at five and the number of sampled haplotypes per species at 1. The birth and death rates were fixed at 200 and 100 per substitution per site, respectively. Haploid population sizes were drawn from an inverse gamma distribution with shape a ¼ 3 and scale b ¼ 0:004.</p>
        <p>This procedure was repeated for both UCLN and for UCED species branch rates. Branch rates were sampled from a lognormal or exponential distribution, in either case with a mean of 1, discretized into 100 bins.</p>
        <p>Phased and aligned Pseudacris sequence data were retrieved from Dryad (http://dx.doi.org/10.5061/dryad.23rc0; last accessed April 20, 2017). Replicating the original analysis, we applied the HKY nucleotide substitution model (Hasegawa et al. 1985) to 22 out of 26 nuclear loci and the GTR model (Tavare ´1986) to the remaining 4. For all models, we used four discrete gamma categories to accommodate among-site rate variation (Yang 1994). Transition/transversion rates and ratios and rate variation shape parameters were estimated, and empirical base frequencies used, all separately for each locus. The relative substitution rate of each locus was estimated using a lognormal prior with a mean l in real space of 1 and a standard deviation r of 0.6. We used a single haplotype sequence per individual per locus, halving the total number of sampled sequences to avoid wasting computational resources.</p>
        <p>For inference of Pseudacris trees, we ran 30 independent StarBEAST2 chains for all 24 conditions for a total of 720 chains. The conditions were each possible combination of strict, species tree relaxed gene tree relaxed clocks, analytical or MCMC population size integration, coordinated or naı ¨ve topology changing operators, and the inclusion or exclusion of coordinated height changing operators. Each chain used the same sequence data but was a independent estimate of convergence because a different random seed was used to initialize each chain.</p>
        <p>A birth-death prior was used for the species tree and both the net diversification and extinction fraction hyperparameters were estimated. A gamma prior was used for MCMC estimated population sizes with a shape fixed at 2 and an estimated mean population size hyperparameter, matching the original *BEAST model (Heled and Drummond 2010). The number of branch rate categories was equal to the number of estimated branch rates (as is the default in BEAST 2), and the standard deviation of the UCLN clock model was fixed at 0.3.</p>
        <p>To ensure convergence of all chains, we ran each chain for an initial length of 2 24 ¼16,777,216 states, sampling every 2 11 ¼ 2; 048 states. Initial chain lengths and sampling rates for all other analyses are in supplementary table S8, Supplementary Material online. ESS values were computed for all recorded statistics after discarding 12.5% of state samples as burn-in. Recorded statistics included 1) the posterior probability, 2) the coalescent probabilities of gene trees, 3) the overall prior probability, 4) the birth death prior probability of the species tree, 5) the phylogenetic likelihood, 6) the net diversification rate, 7) the extinction fraction, 8) the mean population size, and 9) the height of the species tree.</p>
        <p>If any recorded statistic had an ESS below 200, the chain was resumed until the length of the chain had doubled. ESS values were then reevaluated, again after discarding 12.5% of state samples. The length of a chain was continually doubled and ESS values reevaluated until the ESS values of all recorded statistics were above 200. The rate at which trees and statistics were sampled was halved with every chain doubling so that the total number of samples remained constant. Two *BEAST GT-UCLN chains still had insufficient ESS values after running for 2 34 ¼17,179,869,184 states, but all other chains had converged. Estimated ESS values for all chains were used for analyses of computational performance.</p>
        <p>ESS per hour was calculated by dividing the final ESS value for a given statistic by 87.5% of the total CPU time used by that chain to account for burn-in. Likewise, ESS per million states was calculated by dividing the final ESS value by 87.5% of the total number of the states in the chain, then multiplied by one million. For all analyses of computational performance including graphs and linear models, the ESS rate for any given chain was that of the slowest converging statistic for that particular chain.</p>
        <p>Average branch length in coalescent units was calculated by concatenating the output (after discarding the first 12.5% of states as burn-in from each chain) of all 30 chains which used the combination of MCMC population size integration, naı ¨ve topology operators, coordinated node height operators and species tree branch rates. For every sample in the combined posterior distribution, the coalescent length of each branch s ð2N e Þ À1 was calculated from its length in generations s and its effective population size N e . The mean coalescent length of all branches across all samples was taken as the average.</p>
        <p>To test how SPILS affected estimates of per-species branch substitution rates, 96 fully asymmetric species trees were simulated with the topology ((((A,B),C),D),E). All species trees were simulated according to a pure birth Yule process (Yule 1925) with a speciation rate of ten per substitution.</p>
        <p>Haploid population sizes for each branch were chosen independently from an inverse gamma distribution with a shape of 3 and a scale of 0.2. 100 gene trees with one individual per extant species were then simulated for each species tree according to the MSC process using biopy. Finally, 1,000 nt sequence alignments were then simulated for each gene tree according to the Jukes-Cantor substitution model (Jukes and Cantor 1969), no among-site rate variation, a strict molecular clock, and a substitution rate of 1 for each locus.</p>
        <p>StarBEAST2 . doi:10.1093/molbev/msx126</p>
        <p>Sequence alignments were simulated using Seq-Gen (Rambaut Grassly 1997).</p>
        <p>BEAST concatenation and 
            <rs type="software">StarBEAST</rs>2 were then used to estimate the branch rates and divergence times with the species tree topology fixed to the truth. The same substitution model used for simulating sequences (i.e., Jukes-Cantor, no rate variation among sites or loci) was also used for inference. UCLN relaxed clocks were applied to the tree inferred by concatenation and to the 
            <rs type="software">StarBEAST</rs>2 species tree.
        </p>
        <p>The same strategy as applied to Pseudacris was used to ensure convergence of StarBEAST2, but for concatenation mean population sizes and coalescent probabilities are not part of the model and so were not recorded.</p>
        <p>For every converged chain, the posterior expectation and 95% credibility intervals of per-species branch rates were calculated using the 
            <rs type="software">TreeAnnotator</rs> program supplied with BEAST.
        </p>
        <p>All simulation parameters were chosen to be broadly similar to those observed in or estimated from the Pseudacris data set.</p>
        <p>First, 30 species trees were simulated according to a birthdeath process (Gernhard 2008) using biopy with 21 extant species, a speciation rate of 100 and a death rate of 30. This corresponds to a net diversification rate of 70 and an extinction fraction of 0.3. Haploid population sizes for each branch were chosen independently from a gamma distribution with a shape of 2 and a scale of 0.002. For a species with annual generation times, as is the case for at least some Pseudacris species (Caldwell 1987), and a substitution rate of 10 À9 per year this corresponds to an effective population size N e of around two million individuals per generation. Species branch rates were chosen from a log-normal distribution with a mean in real space of 1 and a standard deviation of 0.3, then scaled so that the mean of the branch rates for a given species tree was exactly 1. This ensured that per-branch rates always reflected relative differences in substitution rates.</p>
        <p>For each species tree, 130 gene trees with two sampled haplotype sequences per species were simulated according to the MSC process using biopy. The mean clock rate for each locus was chosen from a log-normal distribution with a mean in real space of 1 and a standard deviation of 0.6.</p>
        <p>For each gene tree, 600 nt long sequence alignments were simulated using Seq-Gen (Rambaut and Grassly 1997). An HKY model was used for all sequence alignments with equal base frequencies, a j value of 3, and a four rate category discretized gamma model of among-site rate variation with a shape a value of 0.2. Hence all inference based on simulated data applied the HKY þ C substitution model to all loci.</p>
        <p>The same combinations of clock models, population size integration and new operators were explored using the simulated data as for Pseudacris to provide more generally applicable results regarding those new techniques. The same number of loci, convergence strategy and calculations of ESS rates were used for both. Both haplotype sequences were used for each species for *BEAST and StarBEAST2.</p>
        <p>To compare the performance of 
            <rs type="software">StarBEAST2</rs> with *BEAST, we ran 30 strict clock and 30 gene tree relaxed clock replicates of the Pseudacris reanalysis using the *BEAST package built into 
            <rs type="software">BEAST</rs> 2. We also reran each simulation replicate using *BEAST with a strict clock and gene tree relaxed clocks. The same priors, substitution models, and convergence strategies as used for 
            <rs type="software">StarBEAST</rs>
            <rs type="version">2</rs> were used with *BEAST.
        </p>
        <p>For both data sets, we reused the StarBEAST2 results for the combination of analytical population size integration, coordinated height-changing operators and naı ¨ve topology operators, which are all enabled by default in 
            <rs type="software">StarBEAST2</rs>. To demonstrate the scaling of 
            <rs type="software">StarBEAST2</rs>, we also reran each simulation replicate with an additional 26 loci (for a total of 52 loci) for all three clock models.
        </p>
        <p>To compare concatenation with 
            <rs type="software">StarBEAST2</rs>, we reran each simulation replicate for each combination of either unphased ambiguity coded sequences or a single haplotype sequence per species, either a strict clock or species tree relaxed clock, and either the original 26 loci or with an additional 104 loci (for a total of 130 loci). We estimated the perlocus rates in the same way as for 
            <rs type="software">StarBEAST</rs>
            <rs type="version">2</rs>, and applied the same convergence strategy as for SPILS concatenation. For species tree clock rates we used the same UCLN parameters as 
            <rs type="software">StarBEAST2</rs> but applied to the concatenated tree, a model equivalent to that described by Rasmussen and Kellis (2007). One concatenation chain using phased haplotypes and a relaxed clock still had insufficient ESS values after running for 2 33 ¼ 8,589,934,592 states, but all other chains had converged. Estimated ESS values for all chains were used for analyses of computational performance and statistical coverage and accuracy.
        </p>
        <p>We also generated 30 replicates from a UCE data set of Crocidura shrews to show that StarBEAST2 can scale to 100 loci. For 1020 out of 1112 loci, the best fitting substitution model was either HKY or a nested model (Giarla and Esselstyn 2015). To simplify configuring substitution models, we chose 100 unique loci at random, and separately for each replicate, from the set of loci which best fit HKY or a nested model. For each replicate we ran *BEAST with a strict clock or gene tree relaxed clock and a subset of 50 loci, StarBEAST2 with all three clock models and the same subset, and StarBEAST2 with all three clock models and all 100 loci. The same priors, substitution model and convergence strategies were used as for the simulated data set. All Crocidura MCMC chains converged. In this study, the rooted Robinson-Foulds distance (Robinson and Foulds 1981) is the number of clades present in only one of the true tree T 1 or the maximum clade credibility tree T 2 . The 95% credible set contains tree topologies selected from topologies present in the posterior sample, in order from high to low posterior probability, until the cumulative probability reached or exceeded 95%.</p>
        <p>b L Species rate c R EðSÞ ¼ c Á L Á R REðSÞ a</p>
        <p>The overall substitution rate at a given locus.</p>
        <p>b</p>
        <p>The length of a given gene tree branch within species tree branch A, B, or AB.</p>
        <p>c</p>
        <p>The substitution rate of species tree branch A, B, or AB. Ogilvie et al. . doi:10.1093/molbev/msx126</p>
        <p>a Gene Tree Uncorrelated Log-Normal relaxed clock. b Species Tree Uncorrelated Log-Normal relaxed clock. c Coordinated topology changing operators relative to naı ¨ve operators. d Addition of coordinated height changing operators. e Analytical integration of population sizes relative to MCMC integration. *P &lt; 0.05. **P &lt; 0.01. ***P &lt; 0.001.</p>
        <p>FIG.</p>
        <p>3. Impact of operators, population size integration and clock models on convergence. The estimated sample size (ESS) per hour for a given replicate used the smallest ESS out of all recorded statistics. Topology refers to the replacement of naı ¨ve nearest-neighbor interchange and subtree prune and regraft operators with coordinated operators. Height refers to the addition of operators which make coordinated changes to node heights. Uncorrelated log-normal relaxed clocks were applied to each gene tree (GT-UCLN) or to the species tree (ST-UCLN). N ¼ 30.</p>
        <p>Mol. Biol. Evol. 34(8):2101-2114 doi:10.1093/molbev/msx126 Advance Access publication April 14, 2017</p>
        <p>Downloaded from https://academic.oup.com/mbe/article-abstract/34/8/2101/3738283 by Australian National University user on 14 December 2017</p>
        <p>This work was supported by a Rutherford Discovery Fellowship awarded to A.J.D. by the Royal Society of New Zealand. H.A.O. was supported by an Australian Laureate Fellowship awarded to Craig Moritz by the Australian Research Council (FL110100104). This research was undertaken with the assistance of resources from the National Computational Infrastructure (NCI), which is supported by the Australian Government. We wish to thank Jason Bragg and Renee Catullo for testing StarBEAST2 before its official release, Timothy Vaughan for suggesting the addition of a root height changing operator, Joseph Heled for insight into the MSC, and Graham Jones for input regarding operator performance. We also thank Tanja Stadler for hosting H.A.O. and A.J.D. during part of the development of StarBEAST2, and thank F abio Mendes, Matthew Hahn, Diego Mallo, two anonymous reviewers and the editor for suggesting valuable improvements to this manuscript.</p>
        <p>Supplementary data are available at Molecular Biology and Evolution online.</p>
    </text>
</tei>
