<?xml version="1.0" encoding="UTF-8"?>
<tei xmlns="http://www.tei-c.org/ns/1.0">
    <teiHeader>
        <fileDesc xml:id="_1"/>
        <encodingDesc>
            <appInfo>
                <application version="0.8.1-SNAPSHOT" ident="GROBID" when="2024-06-14T14:36+0000">
                    <ref target="https://github.com/kermitt2/grobid">A machine learning software for extracting information from scholarly documents</ref>
                </application>
            </appInfo>
        </encodingDesc>
    </teiHeader>
    <text xml:lang="en">
        <p>The 
            <rs type="software">HORACE</rs> suite of programs has been developed to work with large multiple-measurement data sets collected from time-of-flight neutron spectrometers equipped with arrays of position-sensitive detectors. The software allows exploratory studies of the four dimensions of reciprocal space and excitation energy to be undertaken, enabling multi-dimensional subsets to be visualized, algebraically manipulated, and models for the scattering to simulated or fitted to the data. The software is designed to be an extensible framework, thus allowing user-customized operations to be performed on the data. Examples of the use of its features are given for measurements exploring the spin waves of the simple antiferromagnet RbMnF 3 and ferromagnetic iron, and the phonons in URu 2 Si 2 .
        </p>
        <p>Neutron spectrometers at central facilities around the world are routinely used to measure the wave-vector, Q , and energy, ω , dependency of the spectrum of lattice dynamics and magnetic excitations, ω ( ) S Q, . These data can provide detailed information about the strength, range and symmetry of the interatomic and magnetic interactions, and consequently are highly sensitive tests of theoretical models. The triple-axis spectrometer (TAS) at research reactors has traditionally been the instrument of choice because of its controllability and flexibility [1], whereby the ω ( ) S Q, -dependency is explored point-by-point. Over the past 15- 20 years time-of-flight spectrometers with position-sensitive detectors (PSDs) have established themselves as extraordinarily effective instruments for measuring excitations in single crystals where the interactions are strong in one or two dimensions, for example in the cuprate and iron-based superconductors, and in quasi one-and two-dimensional model magnetic systems. [2][3][4][5][6][7][8][9][10][11][12][13][14][15][16][17][18][19][20][21]. However, until recently there have been relatively fewer measurements in systems where there are significant interactions in all three spatial dimensions. By combining many separate runs, each with a different crystal orientation, into a single data set, complete measurements of the four-dimensional scattering function ω ( ) S Q, can be made. This has become possible through the combination of the latest instruments with large solid angle position sensitive detector arrays [22][23][24][25][26][27] and, crucially, optimized software to visualize and manipulate the massive data sets that are created.Neutron spectrometers at central facilities around the world are routinely used to measure the wave-vector, Q , and energy, ω , dependency of the spectrum of lattice dynamics and magnetic excitations, ω ( ) S Q, . These data can provide detailed information about the strength, range and symmetry of the interatomic and magnetic interactions, and consequently are highly sensitive tests of theoretical models. The triple-axis spectrometer (TAS) at research reactors has traditionally been the instrument of choice because of its controllability and flexibility [1], whereby the ω ( ) S Q, -dependency is explored point-by-point. Over the past 15- 20 years time-of-flight spectrometers with position-sensitive detectors (PSDs) have established themselves as extraordinarily effective instruments for measuring excitations in single crystals where the interactions are strong in one or two dimensions, for example in the cuprate and iron-based superconductors, and in quasi one-and two-dimensional model magnetic systems. [2][3][4][5][6][7][8][9][10][11][12][13][14][15][16][17][18][19][20][21]. However, until recently there have been relatively fewer measurements in systems where there are significant interactions in all three spatial dimensions. By combining many separate runs, each with a different crystal orientation, into a single data set, complete measurements of the four-dimensional scattering function ω ( ) S Q, can be made. This has become possible through the combination of the latest instruments with large solid angle position sensitive detector arrays [22][23][24][25][26][27] and, crucially, optimized software to visualize and manipulate the massive data sets that are created.</p>
        <p>Here the software application 
            <rs type="software">HORACE</rs> is described, which is in routine use, at several neutron facilities, by their users for the visualization and analysis of such data sets. This paper describes the background to the experimental method, and the principles of 
            <rs type="software">HORACE</rs> are outlined. The features of the software are described in detail, together with a summary of how it is practically used, with examples that illustrate its operation and features. Details of computer hardware requirements, and software download and installation are also summarized.
        </p>
        <p>Fig. 1 shows a schematic diagram of the MERLIN spectrometer [23] at the ISIS spallation neutron source at the STFC Rutherford Appleton laboratory in the UK, an example of the latest generation of direct geometry spectrometers. In this example, a pulse of protons hits the spallation target every 20 ms to produce a pulse of neutrons. These are rapidly slowed down in a moderator to produce a pulse of neutrons with characteristic width measured in microseconds, but with a spread of useable energies in the instrument of ∼ ∼ 10 meV to 3 eV. A monochromatic pulse of neu- trons with the desired energy E i is selected by correctly choosing Contents lists available at ScienceDirect journal homepage: www.elsevier.com/locate/nima the phase of a rotating collimator (Fermi chopper), or system of disk choppers, just before the sample. The sample scatters neutrons, and on MERLIN these are collected by a three steradian position sensitive detector array. The time of arrival with respect to the proton pulse of each scattered neutron is recorded together with its location on the detector array. Because the moderator-tosample distance x 1 is known, as is the sample-to-detector distance x 2 for each detector element, the magnitude of the scattered wave vector for each recorded neutron is determined by the time-ofarrival at the detector, t det :Fig. 1 shows a schematic diagram of the MERLIN spectrometer [23] at the ISIS spallation neutron source at the STFC Rutherford Appleton laboratory in the UK, an example of the latest generation of direct geometry spectrometers. In this example, a pulse of protons hits the spallation target every 20 ms to produce a pulse of neutrons. These are rapidly slowed down in a moderator to produce a pulse of neutrons with characteristic width measured in microseconds, but with a spread of useable energies in the instrument of ∼ ∼ 10 meV to 3 eV. A monochromatic pulse of neu- trons with the desired energy E i is selected by correctly choosing Contents lists available at ScienceDirect journal homepage: www.elsevier.com/locate/nima the phase of a rotating collimator (Fermi chopper), or system of disk choppers, just before the sample. The sample scatters neutrons, and on MERLIN these are collected by a three steradian position sensitive detector array. The time of arrival with respect to the proton pulse of each scattered neutron is recorded together with its location on the detector array. Because the moderator-tosample distance x 1 is known, as is the sample-to-detector distance x 2 for each detector element, the magnitude of the scattered wave vector for each recorded neutron is determined by the time-ofarrival at the detector, t det :</p>
        <p>is the time the monochromatic pulse hits the sample, k i is the magnitude of the incident wave vector given byis the time the monochromatic pulse hits the sample, k i is the magnitude of the incident wave vector given by</p>
        <p>N , and m N is the mass of the neutron. The momentum and energy transferred to the sample are then computed [28] asN , and m N is the mass of the neutron. The momentum and energy transferred to the sample are then computed [28] as</p>
        <p>For a chosen k i and sample orientation, there are three independent degrees of freedom, corresponding to the spherical polar angles θ and ϕ that define the direction of k f , and the timeof-arrival t det which in turn has a one-to-one correspondence with energy transfer, ω , or equivalently withFor a chosen k i and sample orientation, there are three independent degrees of freedom, corresponding to the spherical polar angles θ and ϕ that define the direction of k f , and the timeof-arrival t det which in turn has a one-to-one correspondence with energy transfer, ω , or equivalently with</p>
        <p>In consequence, the momentum and frequency dependent scattering function ω ( ) S Q, is measured on a 3D manifold in the four dimensions of Q and ω, with the volume defined by the ranges of θ and ϕ set by the size of the detector array, and ω -∞ ≤ ≤ E i . Equivalently, in any particular choice of coordinate frame for Q , then of the four co- ordinates ω { } ≡ ( )In consequence, the momentum and frequency dependent scattering function ω ( ) S Q, is measured on a 3D manifold in the four dimensions of Q and ω, with the volume defined by the ranges of θ and ϕ set by the size of the detector array, and ω -∞ ≤ ≤ E i . Equivalently, in any particular choice of coordinate frame for Q , then of the four co- ordinates ω { } ≡ ( )</p>
        <p>, only three components are independent, with the fourth an implicit function of the other three. We note that a similar line of reasoning can be used for indirect geometry spectrometers, for which the final energy E f is fixed and the time-of-flight is used to determine k i ., only three components are independent, with the fourth an implicit function of the other three. We note that a similar line of reasoning can be used for indirect geometry spectrometers, for which the final energy E f is fixed and the time-of-flight is used to determine k i .</p>
        <p>The physically relevant coordinate frames in which to express the components of Q are ones that are fixed with respect to the crystal lattice. is the implicit coordinate will depend on the material being studied. For example, in some magnetic materials such as the parent high temperature superconductor compound La 2 CuO 4 [29], the magnetic ions are arranged in layers, with the magnetic exchange parameters between the layers orders of magnitude weaker than those within the layers. In this case, the best choice of coordinate frame is one with components Q 1 and Q 2 within the layers and Q 3 perpendicular to the layers. Because the interactions between the layers are negligible, ω ( ) S Q, has a simple dependence on Q 3 , mainly due to the form factor. In this instance, Q 3 is taken to be the implicit variable, and the intensity as a function ofThe physically relevant coordinate frames in which to express the components of Q are ones that are fixed with respect to the crystal lattice. is the implicit coordinate will depend on the material being studied. For example, in some magnetic materials such as the parent high temperature superconductor compound La 2 CuO 4 [29], the magnetic ions are arranged in layers, with the magnetic exchange parameters between the layers orders of magnitude weaker than those within the layers. In this case, the best choice of coordinate frame is one with components Q 1 and Q 2 within the layers and Q 3 perpendicular to the layers. Because the interactions between the layers are negligible, ω ( ) S Q, has a simple dependence on Q 3 , mainly due to the form factor. In this instance, Q 3 is taken to be the implicit variable, and the intensity as a function of</p>
        <p>gives the relevant information of ω ( ) S Q, . Typical plots of ω ( ) S Q, at a constant energy are thus projected along the physically uninteresting Q 3 -axis. In quasi-1D magnets, where the interactions are strong only along one directionlabel it Q 1 for definitenessthen Q 3 can be ignored as the implicit variable and the intensity integrated along Q 2 to improve the statistical quality of the data, and intensity as a function ofgives the relevant information of ω ( ) S Q, . Typical plots of ω ( ) S Q, at a constant energy are thus projected along the physically uninteresting Q 3 -axis. In quasi-1D magnets, where the interactions are strong only along one directionlabel it Q 1 for definitenessthen Q 3 can be ignored as the implicit variable and the intensity integrated along Q 2 to improve the statistical quality of the data, and intensity as a function of</p>
        <p>gives the full information of ω ( ) S Q, . These techniques have been used to study spin dynamics in single crystals since the early 1990s [30][31][32][33], and full mapping of excitations in quasi-2D materials became possible with the advent of the large position sensitive detector array of the MAPS spectrometer [34,35]. They are now routine on time-of-flight spectrometers around the world to study excitations in quasi-1D [11][12][13][14][15][16] and quasi-2D magnets [17][18][19][20][21] as well as copper based [2][3][4][5] and iron based [6][7][8][9][10] superconductors and their parents. Well-established software applications, such as 
            <rs type="software">DAVE</rs> [36], 
            <rs type="software">MSlice</rs> [37], and 
            <rs type="software">Utsusemi</rs> [38] exist to visualize and to perform some analysis of the data. Though it is possible to use the same techniques and software tools to analyze data from 3D materials [39,40], such analysis is far from routine.
        </p>
        <p>In the case of MERLIN the number of detector elements is ≈70, 000, which is typical of the number for similar instruments at other sources, and the energy transfer axis is typically divided into ≈200 energy bins, so that the 3D manifold is divided into ( ) O 10 7 voxels. Typically there will be six 8-byte numbers associated with each voxel -{ } α Q , α = -1 4, intensity and error on the intensity - which accounts for the bulk of any representation of the data set, which in the case of MERLIN amounts to ≈0.5 GB. This is sufficiently small to fit easily into the memory of a commodity PC.In the case of MERLIN the number of detector elements is ≈70, 000, which is typical of the number for similar instruments at other sources, and the energy transfer axis is typically divided into ≈200 energy bins, so that the 3D manifold is divided into ( ) O 10 7 voxels. Typically there will be six 8-byte numbers associated with each voxel -{ } α Q , α = -1 4, intensity and error on the intensity - which accounts for the bulk of any representation of the data set, which in the case of MERLIN amounts to ≈0.5 GB. This is sufficiently small to fit easily into the memory of a commodity PC.</p>
        <p>To map ω ( ) S Q, fully in materials with interactions in all three spatial directions requires an extra degree of freedom. To achieve this, a sequence of data sets is collected, in which an additional parameter is successively incremented between each data collection, or 'run', and the entire collection of data sets is treated as one. Using time-of-flight spectroscopy to map ω ( ) S Q, in single crystals with interactions in all three dimensions using a multi-orientation approach is not in and of itself new. The approach was used along high symmetry directions on instruments with a limited number of detectors in the 1950s and 1960s [41][42][43]. More recently the approach has been used with ( ) O 10 3 non-position sensitive de- tectors to map excitations in the three dimensions of energy and a high symmetry plane in reciprocal space [44,45]. The use of position sensitive detectors to map ω ( ) S Q, in all four dimensions using ( ) O 10 5 detector elements was pioneered on the MAPS spectrometer at ISIS [22] in the mid-2000s [23], and HORACE was written to enable these correspondingly factor-( ) O 10 2 larger data sets to be analyzed effectively. The approach is now an established procedure at several neutron facilities world-wide [46][47][48][49][50][51][52][53][54][55][56][57][58][59][60][61][62]. In addition to HORACE, the applications mentioned above, DAVE [36] and Utsusemi [38], can be used to analyze such data sets.To map ω ( ) S Q, fully in materials with interactions in all three spatial directions requires an extra degree of freedom. To achieve this, a sequence of data sets is collected, in which an additional parameter is successively incremented between each data collection, or 'run', and the entire collection of data sets is treated as one. Using time-of-flight spectroscopy to map ω ( ) S Q, in single crystals with interactions in all three dimensions using a multi-orientation approach is not in and of itself new. The approach was used along high symmetry directions on instruments with a limited number of detectors in the 1950s and 1960s [41][42][43]. More recently the approach has been used with ( ) O 10 3 non-position sensitive de- tectors to map excitations in the three dimensions of energy and a high symmetry plane in reciprocal space [44,45]. The use of position sensitive detectors to map ω ( ) S Q, in all four dimensions using ( ) O 10 5 detector elements was pioneered on the MAPS spectrometer at ISIS [22] in the mid-2000s [23], and HORACE was written to enable these correspondingly factor-( ) O 10 2 larger data sets to be analyzed effectively. The approach is now an established procedure at several neutron facilities world-wide [46][47][48][49][50][51][52][53][54][55][56][57][58][59][60][61][62]. In addition to HORACE, the applications mentioned above, DAVE [36] and Utsusemi [38], can be used to analyze such data sets.</p>
        <p>Two approaches are possible for use with HORACE:Two approaches are possible for use with HORACE:</p>
        <p>1. Rotate the sample about an axis (usually vertical) by some angle, Ψ, typically °-°0.51. Rotate the sample about an axis (usually vertical) by some angle, Ψ, typically °-°0.5</p>
        <p>2 between each run, while keeping the incident neutron energy E i fixed (in the case of an indirect geometry spectrometer the final neutron energy E f is fixed). The range of the angular scan is usually determined by the reciprocal space coverage of the instrument's detectors and the symmetry of the crystal lattice. This method of operation is the one most frequently used. 2. Keep the sample orientation fixed, but increment the incident energy E i by a small amount between runs. This mode is very rarely used, since the scan range in E i must be kept small in order to avoid too much variation in the instrumental resolution between runs. Furthermore, this method gives a much more limited reciprocal space coverage compared to the rotation method. For the following we shall ignore this option in our description of the method, and focus on sample rotation.2 between each run, while keeping the incident neutron energy E i fixed (in the case of an indirect geometry spectrometer the final neutron energy E f is fixed). The range of the angular scan is usually determined by the reciprocal space coverage of the instrument's detectors and the symmetry of the crystal lattice. This method of operation is the one most frequently used. 2. Keep the sample orientation fixed, but increment the incident energy E i by a small amount between runs. This mode is very rarely used, since the scan range in E i must be kept small in order to avoid too much variation in the instrumental resolution between runs. Furthermore, this method gives a much more limited reciprocal space coverage compared to the rotation method. For the following we shall ignore this option in our description of the method, and focus on sample rotation.</p>
        <p>is measured in a 4D manifold. The choice of increment in the additional parameter is based on consideration of the resolution of the instrument. The angular divergence of both the incident and scattered neutron beams is °-°0.5 1 for current chopper spectrometers, and the energy resolution is typicallyis measured in a 4D manifold. The choice of increment in the additional parameter is based on consideration of the resolution of the instrument. The angular divergence of both the incident and scattered neutron beams is °-°0.5 1 for current chopper spectrometers, and the energy resolution is typically</p>
        <p>With continuous streaming of data to disk as a function of absolute time rather than time relative to the most recent proton pulse (that is, event mode collection [63][64][65][66]), then Ψ can in principle be varied continuously, avoiding discretization of data along the corresponding coordinate axis [38,67]. This means that continuous rotation allows one to choose the angle step during the reduction process rather than before acquisition, leading to increased flexibility. Furthermore, if all experimental data, including motor encoders, are recorded with time-stamping then cases when equipment failure occurs part-way through a set of measurements can be dealt with suitably. In practice, runs at different Ψ usually are discretized (i.e. binned) so that software such as 
            <rs type="software">HORACE</rs> may be used to analyze the data.
        </p>
        <p>The main purpose of HORACE is to allow easy visualization, manipulation and analysis of inelastic neutron scattering data, gathered from multiple crystal orientations or incident energies as described above, in the four dimensions of vector momentum and energy. HORACE provides a comprehensive set of elemental functions as an extensible framework for analyzing the data, in which more complex scripts or functions can be rapidly written by users. A guiding principle in the design of HORACE was that it should be possible to run on a high specification laptop or commodity desktop computer, and would pre-process the data to minimize the time to create and visualize subsets cut from the data, despite that hardware constraint.The main purpose of HORACE is to allow easy visualization, manipulation and analysis of inelastic neutron scattering data, gathered from multiple crystal orientations or incident energies as described above, in the four dimensions of vector momentum and energy. HORACE provides a comprehensive set of elemental functions as an extensible framework for analyzing the data, in which more complex scripts or functions can be rapidly written by users. A guiding principle in the design of HORACE was that it should be possible to run on a high specification laptop or commodity desktop computer, and would pre-process the data to minimize the time to create and visualize subsets cut from the data, despite that hardware constraint.</p>
        <p>
            <rs type="software">HORACE</rs> has been written with an object oriented architecture in the commercial high-level technical programming language 
            <rs type="software">Matlab</rs> [68]. The primary object is the sqw object: this contains the signal and variance for each individual detector-energy voxel, meta information describing the detector locations, crystal lattice and crystal orientation for each contributing measurement, and the mapping of the voxels into a Cartesian grid that defines the current plot axes and bin sizes in one, two, three or four dimensions. In addition there is the dnd object: an abbreviated version of the sqw object that does not retain the information of the individual voxels or the detector locations. Generally a dnd object will occupy several orders of magnitude less computer memory than the equivalent sqw object.
        </p>
        <p>The operations that are supported on sqw and dnd objects include:The operations that are supported on sqw and dnd objects include:</p>
        <p>Construction of 4D sqw data from multiple measurements of inelastic neutron scattering data.Construction of 4D sqw data from multiple measurements of inelastic neutron scattering data.</p>
        <p>Creating new sqw objects by taking 1D, 2D, 3D and 4D sub- manifolds from the original sqw object, or any other sqw object created by cutting from a previously created sqw object. We define these as cuts; the axes of the cuts can be chosen to be in arbitrary directions in momentum space, or energy.Creating new sqw objects by taking 1D, 2D, 3D and 4D sub- manifolds from the original sqw object, or any other sqw object created by cutting from a previously created sqw object. We define these as cuts; the axes of the cuts can be chosen to be in arbitrary directions in momentum space, or energy.</p>
        <p>Saving objects to files, and reading appropriate data from files into objects.Saving objects to files, and reading appropriate data from files into objects.</p>
        <p>Plotting 1D, 2D and 3D objects. Unary operations e.g. correction for the detailed balance factor [28], as well as the standard operations such as sign inversion and trigonometrical functions.Plotting 1D, 2D and 3D objects. Unary operations e.g. correction for the detailed balance factor [28], as well as the standard operations such as sign inversion and trigonometrical functions.</p>
        <p>Binary operations þ, -,*, /, ∧. Replication of a lower dimensional cut along the additional axes of a higher dimensional cut . This is useful e.g. for creating background estimates to be subtracted from the higher dimensional cut. Symmetrization 1 of sqw objects. Simulation and fitting of models of the scattering functionBinary operations þ, -,*, /, ∧. Replication of a lower dimensional cut along the additional axes of a higher dimensional cut . This is useful e.g. for creating background estimates to be subtracted from the higher dimensional cut. Symmetrization 1 of sqw objects. Simulation and fitting of models of the scattering function</p>
        <p>In addition, there is a tool for planning the range of crystal orientations at which to make measurements in order to map a desired volume of momentum and energy, and utilities for plotting data or models of dispersion relations and the scattering function as a function of energy and momentum along a sequence 1 In this context, symmetrization refers to folding the data about a plane in Q so that symmetrically equivalent points in the reciprocal space covered by the detectors can be combined to give improved statistics on the signal in a single ω ( ) Q, bin.In addition, there is a tool for planning the range of crystal orientations at which to make measurements in order to map a desired volume of momentum and energy, and utilities for plotting data or models of dispersion relations and the scattering function as a function of energy and momentum along a sequence 1 In this context, symmetrization refers to folding the data about a plane in Q so that symmetrically equivalent points in the reciprocal space covered by the detectors can be combined to give improved statistics on the signal in a single ω ( ) Q, bin.</p>
        <p>of high-symmetry directions in reciprocal space. Examples of the use of these operations on illustrative data sets will be given in Section 5.of high-symmetry directions in reciprocal space. Examples of the use of these operations on illustrative data sets will be given in Section 5.</p>
        <p>In order to satisfy the requirement that HORACE can operate on a commodity personal computer and to minimize the time to make a cut, the data are coarse-grain sorted on to a regular 4D grid in the ω ( ) Q, -space (by default fifty steps along each dimension), and then saved into a single (generally large) file with the extension . sqw. The advantage of this sorting when the data are saved to file is that to access a particular volume of reciprocal space and energy window, which is typically the case when visualizing and analyzing a 1D or 2D cut, the entire large sqw file (a full description of which is provided in Appendix B) need not be read from disk to search for contributing detector voxels. Instead, just the data in those bins in the grid which intersect the reciprocal space volume and energy window of the cut need to be read. This provides a significant saving of time when extracting such subsets, and is one of the key features of HORACE compared to its predecessors. It should be noted that algorithms to process data that are too large to fit into memory are widely used [69], for example in medical imaging [70], geographic information systems [71], and generally in multi-dimensional graphics processing [72]. The algorithm developed here was optimized to minimize disk access for the specific nature of the neutron data and the primary operation of taking cuts that contain a small fraction of the total data.In order to satisfy the requirement that HORACE can operate on a commodity personal computer and to minimize the time to make a cut, the data are coarse-grain sorted on to a regular 4D grid in the ω ( ) Q, -space (by default fifty steps along each dimension), and then saved into a single (generally large) file with the extension . sqw. The advantage of this sorting when the data are saved to file is that to access a particular volume of reciprocal space and energy window, which is typically the case when visualizing and analyzing a 1D or 2D cut, the entire large sqw file (a full description of which is provided in Appendix B) need not be read from disk to search for contributing detector voxels. Instead, just the data in those bins in the grid which intersect the reciprocal space volume and energy window of the cut need to be read. This provides a significant saving of time when extracting such subsets, and is one of the key features of HORACE compared to its predecessors. It should be noted that algorithms to process data that are too large to fit into memory are widely used [69], for example in medical imaging [70], geographic information systems [71], and generally in multi-dimensional graphics processing [72]. The algorithm developed here was optimized to minimize disk access for the specific nature of the neutron data and the primary operation of taking cuts that contain a small fraction of the total data.</p>
        <p>Every operation that HORACE can perform has been written as a 
            <rs type="software">Matlab</rs> function. There are two possible ways of interacting with the program. The first, and most common, is through the 
            <rs type="software">Matlab</rs> command line, or for more complex sequences of commands through the user's own 
            <rs type="software">Matlab</rs>
            <rs type="software">scripts</rs> or functions. An example of HORACE in use with the 
            <rs type="software">Matlab</rs> command line is shown in Fig. 2(a), together with two plots generated during the series of commands shown. In this particular case a cut is taken from a file and plotted. The cut is then symmetrized in two planes, and the result of this operation is also plotted. The second method for interacting with HORACE is through a graphical user interface (GUI), shown in Fig. 2 (b), which allows access to a subset of the functionality of the main program chosen to allow execution of the most common and/or simplest tasks. Note that use of the GUI still requires 
            <rs type="software">Matlab</rs> to be installed on one's computer.
        </p>
        <p>Practical operation of 
            <rs type="software">HORACE</rs> is a two-stage procedure. The first, pre-processing, stage is the creation of the sqw files, which is done for on-the-fly analysis during experiments as data accumulate, and then usually once at the end of an experiment to create reference sqw files for later analysis. These are created from multiple individual run files, which contain the measured scattering intensity ω ( ) S Q, for each detector as a function of energy transfer. Such files are created from the raw time-of-flight data, with correction for detector efficiency, absorption by the sample, etc. using, for example, the 
            <rs type="software">Mantid</rs> software [73]. Alternatively, if the user can read their scattering data and detector parameters into 
            <rs type="software">Matlab</rs> arrays, utility functions provided as part of 
            <rs type="software">HORACE</rs> can be used to write the data into one of the recognized input file formats. Details about input file formats are given in Appendix A. Each individual run file is sorted on to a common 4D grid, and then the sorted files are combined a piece at a time into the final sqw file. This file-backed combination limits the memory that is required, which is crucial when one considers the size of the final sqw file, which can typically range in size from 10 to 500 GB. The sqw file is a binary file that allows direct read access to its contents so only those voxels in those bins required for a particular operation need to be read. Given the size of a typical sqw file, it is not generally recommended, nor in fact necessary, to access the data in individual voxels. 
            <rs type="software">HORACE</rs> provides utility functions to access header information and the intensity and estimated variance in the bins in an sqw file. Further details of the sqw object and file format are given in Appendix B.
        </p>
        <p>Once the sqw file has been created, cuts of any dimensionality can be taken and any of the manipulations detailed in Section 3.2 applied to them. We include in this the ability to plot 1D, 2D, and 3D cuts, since this is the way in which the user typically interacts with the data. A typical workflow might be to take a series of cuts and plot them to investigate some region of interest, apply some corrections (e.g. magnetic form factor, background subtraction, or Bose-Einstein population factor), then simulate and fit a model to these data in order to extract some physically meaningful parameters.Once the sqw file has been created, cuts of any dimensionality can be taken and any of the manipulations detailed in Section 3.2 applied to them. We include in this the ability to plot 1D, 2D, and 3D cuts, since this is the way in which the user typically interacts with the data. A typical workflow might be to take a series of cuts and plot them to investigate some region of interest, apply some corrections (e.g. magnetic form factor, background subtraction, or Bose-Einstein population factor), then simulate and fit a model to these data in order to extract some physically meaningful parameters.</p>
        <p>Illustrative examples -RbMnF 3 , Fe and URu 2 Si 2Illustrative examples -RbMnF 3 , Fe and URu 2 Si 2</p>
        <p>We will give a basic illustration of some of the functionality of HORACE with reference to data taken on the following three examples, RbMnF 3 , iron and URu 2 Si 2 . RbMnF 3 has a cubic crystal structure and is very close to being an ideal 3D Heisenberg antiferromagnet. It has a large spin ( = ) S 5/2 on its Mn 2 þ sites, making it a strong magnetic scatterer of neutrons. It has a nearest-neighbor isotropic exchange constant of J¼ 0.29 meV, and a next-nearest-neighbor exchange constant that is an order of magnitude smaller [74]. Iron is the canonical example of an itinerant-electron metallic magnet. Below about 100 meV sharp spin waves have been shown to exist [75], but time-of-flight inelastic neutron scattering experiments have also shown that spin fluctuations persist up to much higher energies of at least 550 meV [76]. The data shown here will be the subject of future scientific reports, and are used here for illustrative purposes only. URu 2 Si 2 has been actively studied for many years due to the mysterious 'hidden order' that it exhibits [77], which is responsible for a large change in entropy but cannot be explained by a conventional order parameter such as dipolar magnetic order. Recent interest has focused on whether the lattice is coupled to the hidden order parameter, and several studies of the phonons have been published [78,79]. The data we show here are in agreement with the already-published work, but cover a much larger volume of reciprocal space by virtue of the fact that we used the method of data collection outlined in this paper.We will give a basic illustration of some of the functionality of HORACE with reference to data taken on the following three examples, RbMnF 3 , iron and URu 2 Si 2 . RbMnF 3 has a cubic crystal structure and is very close to being an ideal 3D Heisenberg antiferromagnet. It has a large spin ( = ) S 5/2 on its Mn 2 þ sites, making it a strong magnetic scatterer of neutrons. It has a nearest-neighbor isotropic exchange constant of J¼ 0.29 meV, and a next-nearest-neighbor exchange constant that is an order of magnitude smaller [74]. Iron is the canonical example of an itinerant-electron metallic magnet. Below about 100 meV sharp spin waves have been shown to exist [75], but time-of-flight inelastic neutron scattering experiments have also shown that spin fluctuations persist up to much higher energies of at least 550 meV [76]. The data shown here will be the subject of future scientific reports, and are used here for illustrative purposes only. URu 2 Si 2 has been actively studied for many years due to the mysterious 'hidden order' that it exhibits [77], which is responsible for a large change in entropy but cannot be explained by a conventional order parameter such as dipolar magnetic order. Recent interest has focused on whether the lattice is coupled to the hidden order parameter, and several studies of the phonons have been published [78,79]. The data we show here are in agreement with the already-published work, but cover a much larger volume of reciprocal space by virtue of the fact that we used the method of data collection outlined in this paper.</p>
        <p>We now provide a more comprehensive discussion of how the program is typically used.We now provide a more comprehensive discussion of how the program is typically used.</p>
        <p>The first step when performing an experiment is often to determine an appropriate choice of instrument parameters, such as incident neutron energy and range of sample orientations to be scanned. Different combinations give access to different regions of reciprocal space, and with the limited time available to run an experiment it is crucial to decide quickly the right instrumental configuration. To help with this a standalone GUI is provided with 
            <rs type="software">HORACE</rs>, the scan_planner. Given a set of basic inputs concerning the lattice parameters and angles, sample orientation, instrument detector positions and incident neutron energy, the program plots the volume of Q -space covered by those detectors for a given energy transfer. To aid the planning process the volume is semiopaque and colored according to the sample orientation angle, and the positions of integer ( ) H K L , , are plotted as black spheres. An example screenshot is shown in Fig. 3.
        </p>
        <p>The selection of individual run files to combine into an sqw file may be performed either in a 
            <rs type="software">Matlab</rs>
            <rs type="software">script</rs> or through the GUI. Metadata about the experimental setup for each run must be manually provided by the user, specifically the incident energy, sample orientation, lattice parameters and lattice angles. For the RbMnF 3 data set we combined 85 individual measurements at different sample orientations, each of which was 122 MB, taken on the MAPS time-of-flight neutron spectrometer at ISIS [22]. The scattering plane was ( )( )
        </p>
        <p>1, 1, 0 / 0, 0, 1 and Ψ was scanned from °6 to °90 in °1 steps. The resultant sqw file was 15 GB, and additional working space of about the same size on disk as the sqw file was required during its creation. For the iron data set, also obtained on the MAPS spectrometer, 186 runs were combined to make an sqw file of 36 GB. The scan was performed with the ( )( ) 1, 0, 0 / 0, 1, 0 scattering plane, and Ψ scanned from - °92.5 to °0 in °0.5 steps. The URu 2 Si 2 dataset was obtained on MERLIN, and comprised 276 runs which combined gave an sqw file of size 136 GB. Generally speaking a larger number of runs and / or instruments with a larger number of detector elements give rise to larger sqw files, which take commensurately longer to generate.1, 1, 0 / 0, 0, 1 and Ψ was scanned from °6 to °90 in °1 steps. The resultant sqw file was 15 GB, and additional working space of about the same size on disk as the sqw file was required during its creation. For the iron data set, also obtained on the MAPS spectrometer, 186 runs were combined to make an sqw file of 36 GB. The scan was performed with the ( )( ) 1, 0, 0 / 0, 1, 0 scattering plane, and Ψ scanned from - °92.5 to °0 in °0.5 steps. The URu 2 Si 2 dataset was obtained on MERLIN, and comprised 276 runs which combined gave an sqw file of size 136 GB. Generally speaking a larger number of runs and / or instruments with a larger number of detector elements give rise to larger sqw files, which take commensurately longer to generate.</p>
        <p>Speed-up of the creation of the sqw file, and other computationally intensive operations such as taking cuts (see below), is achieved by using C þ þ routines in place of 
            <rs type="software">Matlab</rs> ones. These are invoked using 
            <rs type="software">Matlab</rs>'s in-built mex file system [68], whereby 
            <rs type="software">Matlab</rs>
            <rs type="software">routines</rs> may call subroutines written in another language. The Cþ þ routines utilize both multi-threaded processing as well as the intrinsic speed gains that are typically obtained when comparing an interpreted language (
            <rs type="software">Matlab</rs>) with a compiled language (C þ þ).
        </p>
        <p>The time taken to perform the combination of files is highly dependent on the computer on which it is performed. For benchmarking we used an sqw file of size 142 GB, which comprised data from 231 runs. On a 
            <rs type="software">Windows 7</rs> workstation with available disk space of several TB (i.e. much more than the sqw file size), with 48 GB RAM and running 12-core Intel Xeon X5650 processors (2.67 GHz), the total time to generate the sqw file was 150 min when using 
            <rs type="software">Matlab</rs>
            <rs type="version">2015b</rs> (later versions of 
            <rs type="software">Matlab</rs> include internal multi-threading procedures, which offer similar speed to Mex acceleration in this case). On a machine running 
            <rs type="software">CentOS7</rs> with the same hardware, and with Mex file acceleration enabled and running on 8 threads, the total optimized time was 52 min. However, recent versions of 
            <rs type="software">Horace</rs> contain extensions to the code that allow better utilization of high performance computing capabilities that are increasingly available. By way of example, the 
            <rs type="software">ISIScompute</rs> service available to ISIS facility users, which comprises a machine running 
            <rs type="software">RHEL 7</rs> with 96 Intel Xeon E5-4657L processors (2.5 GHz), 512 GB of RAM and a 100 TB CEPH parallel file system [80], is able to produce the same 142 GB file in around 8 min.
        </p>
        <p>We have noted already that HORACE has been designed to be operable on a typical commodity PC, which may well have a lower specification than that described above for our benchmarks. Provided sufficient disk space is available to store the sqw file and the temporary working space needed during its creation, lack of RAM and CPU speed need not prevent the operation of HORACE. Options are provided whereby the size of chunks read from disk to memory for processing can be changed, so for a PC with less RAM these numbers can be reduced appropriately. The time taken to generate files and take cuts from them will increase, and the number of sqw objects that can be held in memory is smaller, but otherwise the full functionality of HORACE is available. During a typical experiment the user will often wish to examine data from a partially complete scan of sample orientations, in order to make decisions about what future measurements to make. Rather than regenerating the entire sqw file when more runs have been completed, it is possible to provide a list of planned runs and sample orientations, so that future data may be binned on to the same coarse-grained grid and inserted into the existing sqw file, thus saving time, especially with larger files.We have noted already that HORACE has been designed to be operable on a typical commodity PC, which may well have a lower specification than that described above for our benchmarks. Provided sufficient disk space is available to store the sqw file and the temporary working space needed during its creation, lack of RAM and CPU speed need not prevent the operation of HORACE. Options are provided whereby the size of chunks read from disk to memory for processing can be changed, so for a PC with less RAM these numbers can be reduced appropriately. The time taken to generate files and take cuts from them will increase, and the number of sqw objects that can be held in memory is smaller, but otherwise the full functionality of HORACE is available. During a typical experiment the user will often wish to examine data from a partially complete scan of sample orientations, in order to make decisions about what future measurements to make. Rather than regenerating the entire sqw file when more runs have been completed, it is possible to provide a list of planned runs and sample orientations, so that future data may be binned on to the same coarse-grained grid and inserted into the existing sqw file, thus saving time, especially with larger files.</p>
        <p>Once the sqw file has been created, HORACE is also used to visualize and analyze the data. Typically users wish to sample 3D volumes, 2D slices and 1D cuts along specified trajectories in ω ( ) Q, -space. As mentioned in Section 3.2, we refer to such subsets in general terms as 'cuts'. HORACE provides complete flexibility to cut along any Q -direction, or along the energy direction, irre- spective of the orientation of the sample with respect to the instrument. When making a cut the user specifies a grid onto which data are binned, with the bin sizes chosen typically to contain data from many detector voxels. It is at this stage that the coarse grain sorting of the data during the generation of the sqw file, described earlier, provides a significant speed advantage since only a small fraction of the total (very large) file needs to be read to obtain all the information required for any given cut. Once these cuts from the data are read from disk they are stored in memory and are accessible as objects in the 
            <rs type="software">Matlab</rs> workspace, so that provided sufficient computer memory is available multiple cuts may be retained for future visualization and/or analysis. Every cut has the same structure as the data in the sqw file, so further cuts may be taken from objects in memory without loss of information.
        </p>
        <p>
            <rs type="software">HORACE</rs> provides tools to visualize 1D, 2D and 3D cuts as, respectively, marker plots with errorbars, colormaps, and multiple colormaps plotted on a 3D set of axes, examples of which are shown in Fig. 4. These plots are highly customizable, and because the plots are ultimately generated using 
            <rs type="software">Matlab</rs>'s native graphics they can also be modified using the in-built routines. It is thus fairly common that 
            <rs type="software">HORACE</rs> is used directly to produce figures that are used in publications, in addition to being used for the analysis [46][47][48][49][50][51][52][53][81][82][83].
        </p>
        <p>In order to survey a large section of reciprocal space (i.e. a 3D cut) the sliceomatic tool [84] is used. A screen-shot of sliceomatic in use is shown in Fig. 4(a), with the intensity of the scattering given by a color map. Dispersive excitations with the same periodicity as the Brillouin zone are clearly visible. The user may move the visible slice planes on this interface, in order to explore a large section of the data very quickly. Fig. 4(b) shows a 2D slice, centered on the ( ) 1/2, 1/2, 1/2 position, with axes of ( ) L 1/2, 1/2, and neutron energy transfer. The slice clearly shows scattering from a band of dispersive magnetic excitations in the range ≤ ≤ E 0 9meV. The white lines at L¼ 0, L¼ 0.15, and L ¼0.3 show where 1D cuts were madethese cuts are shown in Fig. 4(c). The cuts were taken by averaging the signal along L, ±0.05 r.l.u. either side of the stated value.In order to survey a large section of reciprocal space (i.e. a 3D cut) the sliceomatic tool [84] is used. A screen-shot of sliceomatic in use is shown in Fig. 4(a), with the intensity of the scattering given by a color map. Dispersive excitations with the same periodicity as the Brillouin zone are clearly visible. The user may move the visible slice planes on this interface, in order to explore a large section of the data very quickly. Fig. 4(b) shows a 2D slice, centered on the ( ) 1/2, 1/2, 1/2 position, with axes of ( ) L 1/2, 1/2, and neutron energy transfer. The slice clearly shows scattering from a band of dispersive magnetic excitations in the range ≤ ≤ E 0 9meV. The white lines at L¼ 0, L¼ 0.15, and L ¼0.3 show where 1D cuts were madethese cuts are shown in Fig. 4(c). The cuts were taken by averaging the signal along L, ±0.05 r.l.u. either side of the stated value.</p>
        <p>It can often be useful to view the dispersion along several high symmetry directions on a single plot, for example when investigating phonons and comparing to DFT calculations. The HOR-ACE tool spaghetti_plot can be used for this purpose. An example of its use is shown in Fig. 5 in which we show the phonon dispersion around = ( -) Q 2, 2, 0 in URu 2 Si 2 . One can see, for ex- ample, the splitting of two different acoustic modes along the Γ -Σ trajectory as well as multifarious modes at higher energies which disperse differently along different symmetry directions.It can often be useful to view the dispersion along several high symmetry directions on a single plot, for example when investigating phonons and comparing to DFT calculations. The HOR-ACE tool spaghetti_plot can be used for this purpose. An example of its use is shown in Fig. 5 in which we show the phonon dispersion around = ( -) Q 2, 2, 0 in URu 2 Si 2 . One can see, for ex- ample, the splitting of two different acoustic modes along the Γ -Σ trajectory as well as multifarious modes at higher energies which disperse differently along different symmetry directions.</p>
        <p>There are several different ways one can manipulate sqw and dnd objects. Unary operations that apply to the intensity, e.g. Bose-Einstein population factor or magnetic form factor correction of the intensity, and binary operations, e.g. subtraction of the intensity of one object from another (such as required for background subtraction), may be performed.There are several different ways one can manipulate sqw and dnd objects. Unary operations that apply to the intensity, e.g. Bose-Einstein population factor or magnetic form factor correction of the intensity, and binary operations, e.g. subtraction of the intensity of one object from another (such as required for background subtraction), may be performed.</p>
        <p>Data of dnd form may be smoothed by convolution with an appropriate dimensional Gaussian or hat function of a specified width. Such smoothed objects allow a simple way to visualize data part-way through an experiment, before sufficient statistical quality has been obtained through longer measurement times. By definition sqw data may not be smoothed, since the relationship between the intensity that is plotted and the underlying detector voxel information must be maintained for such objects.Data of dnd form may be smoothed by convolution with an appropriate dimensional Gaussian or hat function of a specified width. Such smoothed objects allow a simple way to visualize data part-way through an experiment, before sufficient statistical quality has been obtained through longer measurement times. By definition sqw data may not be smoothed, since the relationship between the intensity that is plotted and the underlying detector voxel information must be maintained for such objects.</p>
        <p>It is possible to repeatedly tile a lower dimensional dnd data set into a higher dimensional one, e.g. replicate a 1D cut along the energy axis along some Q -axis to create a 2D cut with axes of Q and energy. This is useful when performing background subtractions, since in some cases the intrinsic background may depend on energy but weakly or not at all on Q . Thus a 1D cut along energy may be taken in some region where there is only background, and then this can be subtracted from another region of the data to leave just the contribution to the signal from the intrinsic ω ( ) S Q, . An example of such a procedure is shown in Fig. 6 for the iron dataset. Here, a region (highlighted by the dashed rectangle) is selected that is representative of the non-magnetic background and a 1D cut is performed (panel b). This cut is then replicated over the full Q-range of the original 2D slice (panel a) and then subtracted (panel c).It is possible to repeatedly tile a lower dimensional dnd data set into a higher dimensional one, e.g. replicate a 1D cut along the energy axis along some Q -axis to create a 2D cut with axes of Q and energy. This is useful when performing background subtractions, since in some cases the intrinsic background may depend on energy but weakly or not at all on Q . Thus a 1D cut along energy may be taken in some region where there is only background, and then this can be subtracted from another region of the data to leave just the contribution to the signal from the intrinsic ω ( ) S Q, . An example of such a procedure is shown in Fig. 6 for the iron dataset. Here, a region (highlighted by the dashed rectangle) is selected that is representative of the non-magnetic background and a 1D cut is performed (panel b). This cut is then replicated over the full Q-range of the original 2D slice (panel a) and then subtracted (panel c).</p>
        <p>HORACE provides the ability to fit and simulate (which is simply a single evaluation of a fit function) the data for precisely the same values of ω ( ) Q, that were measured. Models for fitting can take two forms, either generic functions of the plot coordinates (e.g. Gaussian peaks and the like) or more physically meaningful models that calculate ω ( ) S Q, directly. The former is useful for fitting, for example, peak functions on 1D cuts to give a quick parameterization of a dispersion relation. The latter are much more powerful, and can be used to determine physical parameters directly from the data. It is particularly for the fitting of ω ( ) S Q, models that the full detector voxel information retained in sqw objects is most useful. The model function is evaluated for all of the voxels, and then combined to give the intensity in a particular ω ( ) Q, -space bin, rather than just at the bin center as would be the case for a dnd object. For models where ω ( ) S Q, varies appreciably across the width of one bin, this can result in systematic problems if evaluating only using dnd objects, whereas sqw objects generally provide a more accurate fit. On the other hand, because there are usually many detector voxels contributing to the signal in a given bin, evaluation of a model using an sqw object can take much longer due to the greater amount of computer processing required.HORACE provides the ability to fit and simulate (which is simply a single evaluation of a fit function) the data for precisely the same values of ω ( ) Q, that were measured. Models for fitting can take two forms, either generic functions of the plot coordinates (e.g. Gaussian peaks and the like) or more physically meaningful models that calculate ω ( ) S Q, directly. The former is useful for fitting, for example, peak functions on 1D cuts to give a quick parameterization of a dispersion relation. The latter are much more powerful, and can be used to determine physical parameters directly from the data. It is particularly for the fitting of ω ( ) S Q, models that the full detector voxel information retained in sqw objects is most useful. The model function is evaluated for all of the voxels, and then combined to give the intensity in a particular ω ( ) Q, -space bin, rather than just at the bin center as would be the case for a dnd object. For models where ω ( ) S Q, varies appreciably across the width of one bin, this can result in systematic problems if evaluating only using dnd objects, whereas sqw objects generally provide a more accurate fit. On the other hand, because there are usually many detector voxels contributing to the signal in a given bin, evaluation of a model using an sqw object can take much longer due to the greater amount of computer processing required.</p>
        <p>The fitting routines provided with HORACE are designed to work to a high level of abstraction. A key feature of the fitting capability of HORACE is that fits can be performed on an arbitrary number of cuts of any dimensionality, using a global model with global parameters. The fit routines allow a distinction between 'foreground' (often global) and 'background' (usually local to each cut), with the former typically being a model of ω ( ) S Q, and the latter being generic function(s) such as a linear sloping background. This distinction is especially powerful when fitting multiple cuts, since a larger part of the overall dataset can be used to constrain a model, achieving higher accuracy, while allowing for the fact that the instrumental background often varies in unusual ways from cut to cut. Such a philosophy for the fitting was developed in recognition of the form that real data take. As is the case for most fitting procedures, one can specify which fit parameters can vary or remain fixed, and can also bind parameters together in a fixed ratio. Fit functions can take as inputs information of any form (e.g. lookup tables, as well as numeric parameters). Instrumental resolution broadening can at present be included in a crude way as part of the fit function, such a applying a Gaussian broadening in energy, but a specific model for instrumental resolution is not included in HORACE at the moment.The fitting routines provided with HORACE are designed to work to a high level of abstraction. A key feature of the fitting capability of HORACE is that fits can be performed on an arbitrary number of cuts of any dimensionality, using a global model with global parameters. The fit routines allow a distinction between 'foreground' (often global) and 'background' (usually local to each cut), with the former typically being a model of ω ( ) S Q, and the latter being generic function(s) such as a linear sloping background. This distinction is especially powerful when fitting multiple cuts, since a larger part of the overall dataset can be used to constrain a model, achieving higher accuracy, while allowing for the fact that the instrumental background often varies in unusual ways from cut to cut. Such a philosophy for the fitting was developed in recognition of the form that real data take. As is the case for most fitting procedures, one can specify which fit parameters can vary or remain fixed, and can also bind parameters together in a fixed ratio. Fit functions can take as inputs information of any form (e.g. lookup tables, as well as numeric parameters). Instrumental resolution broadening can at present be included in a crude way as part of the fit function, such a applying a Gaussian broadening in energy, but a specific model for instrumental resolution is not included in HORACE at the moment.</p>
        <p>It should be noted that the ability to perform such flexible fitting operations also allows straightforward direct comparisons of known samples to be performed, which is useful both for checking reproducibility of results and also doing instrumental calibrations and checks. For example, a system such as RbMnF 3 , with a well known analytical model for ω ( ) S Q, and well characterized exchange parameters can be measured and the results fitted. The exchange parameters extracted from the fit can then be compared to those obtained on other instruments and detailed in the literature [74]. Following this procedure on the dataset used to generate Fig. 4 we obtained = ( ) J 0.293 8 meV, which compares favorably with the reported value of = ( ) J 0.29 3 meV.It should be noted that the ability to perform such flexible fitting operations also allows straightforward direct comparisons of known samples to be performed, which is useful both for checking reproducibility of results and also doing instrumental calibrations and checks. For example, a system such as RbMnF 3 , with a well known analytical model for ω ( ) S Q, and well characterized exchange parameters can be measured and the results fitted. The exchange parameters extracted from the fit can then be compared to those obtained on other instruments and detailed in the literature [74]. Following this procedure on the dataset used to generate Fig. 4 we obtained = ( ) J 0.293 8 meV, which compares favorably with the reported value of = ( ) J 0.29 3 meV.</p>
        <p>We have written a suite of programs, 
            <rs type="software">HORACE</rs>, to take multiple runs from time-of-flight neutron inelastic scattering experiments, and combine them in one single large data set that can be hundreds of GB in size. The program is designed to be an extensible framework that allows a range of sophisticated manipulations to be performed on the data. The program is also used to visualize subsections of the large data set, with a coarse grained sorting of detector voxels' ω ( ) Q, coordinate ensuring fast access to the relevant subsection of the large data file. The program may also be used for simulations and fits to the data with ( ) ω S Q, models. This includes the ability to fit multiple datasets with a global foreground model and set of parameters, but independent background models and parameters. This is a method geared towards the physical origin of the measured signal, and provides a convenient framework for performing the kind of analysis which is often done in an ad hoc fashion otherwise.
        </p>
        <p>Other than sufficient disk space to store the spe and sqw files, whose sizes are rather dependent on the instrument used for the measurements, the main hardware requirement is to have at least 8 GB of RAM. It has been found that less than this severely hampers the user's ability to exploit HORACE fully with their data. 
            <rs type="software">HORACE</rs> has been tested on the following operating systems: 32-bit and 64-bit 
            <rs type="creator">Microsoft</rs>
            <rs type="software">Windows</rs>, 64-bit 
            <rs type="software">RHEL</rs>
            <rs type="version">6 and 7</rs>, and 
            <rs type="creator">Ubuntu</rs>
            <rs type="software">Linux</rs>
            <rs type="version">10.04</rs> and later, and on Mac OS X 10.
            <rs type="version">5.6</rs> and later. 
            <rs type="software">HORACE</rs> is written using 
            <rs type="software">Matlab</rs>, and has been tested on 
            <rs type="software">Matlab</rs> versions 
            <rs type="version">2009a</rs> onwards. HORACE will continue to be supported in the future for at least the most recent five years' worth of 
            <rs type="software">Matlab</rs> versions. 
            <rs type="software">HORACE</rs> is actively maintained for the above operating systems, but in principle, provided one is able to run a sufficiently recent version of 
            <rs type="software">Matlab</rs>, it should be possible to run 
            <rs type="software">HORACE</rs> no matter what the operating system (e.g. other 
            <rs type="software">Linux</rs> distributions) without Mex files. The C þ þ 
            <rs type="software">code</rs> is also available for the user to perform their own compilation of Mex files if desired.
        </p>
        <p>Zip files containing the compiled 
            <rs type="software">HORACE</rs>
            <rs type="software">Matlab</rs>
            <rs type="software">code</rs> can be downloaded from 
            <rs type="url">http://www.horace.isis.rl.ac.uk</rs>. The full source 
            <rs type="software">code</rs> is available on request. Users are requested to register an email address when they download the code from the website, so that they can be informed from time to time of new releases and bug-fixes. Installation involves simply unzipping the download into a suitable directory, adding this directory to the 
            <rs type="software">Matlab</rs> path, and running a short 
            <rs type="software">Matlab</rs> routine called 
            <rs type="software">horace_on</rs> to initialize a more complete and self-consistent set of search paths for 
            <rs type="software">Matlab</rs>. A full manual giving complete instructions on installation and use, together with details of how to contact the developers, is also available at this website.
        </p>
        <p>recognized by several other neutron visualization and analysis programs. Some programs can also write their own output as spe files, and consequently the spe file is sometimes used as a transportable format data file for time-of-flight neutron spectrometers. Full details of the two ASCII file formats are given in the input file formats page of the HORACE web site [85]. However, it is not recommended to create new spe files as this is now an essentially obsolete file format.recognized by several other neutron visualization and analysis programs. Some programs can also write their own output as spe files, and consequently the spe file is sometimes used as a transportable format data file for time-of-flight neutron spectrometers. Full details of the two ASCII file formats are given in the input file formats page of the HORACE web site [85]. However, it is not recommended to create new spe files as this is now an essentially obsolete file format.</p>
        <p>The recommended input data file is the 
            <rs type="software">nxspe</rs> file, which holds both the ω ( ) S data and errors for each detector and detector position and size information, together with crystal orientation angle Ψ and the incident neutron energy E i . The 
            <rs type="software">nxspe</rs> file stores the information in a 
            <rs type="software">NeXus</rs> format file [86,87], which is a common data exchange format for neutron, X-ray and muon data that is built on top of the HDF5 (Hierarchical Data Format) scientific data format [88].
        </p>
        <p>Data files in the nxspe format are produced by Mantid [73,89], an open source data manipulation and analysis framework for neutron and muon data analysis. They are directly produced by the data reduction algorithms within Mantid for the direct and indirect geometry spectrometers at both the ISIS spallation neutron source at the Rutherford Appleton Laboratory in the UK and the SNS spallation neutron source at Oak Ridge National Laboratory in the USA. If Mantid is used to perform the data corrections for a neutron spectrometer, then the algorithm SaveNXSPE in Mantid can be used to output nxspe files. Full details of how to use Mantid and the input/output for each algorithm are available at the Mantid web site [89].Data files in the nxspe format are produced by Mantid [73,89], an open source data manipulation and analysis framework for neutron and muon data analysis. They are directly produced by the data reduction algorithms within Mantid for the direct and indirect geometry spectrometers at both the ISIS spallation neutron source at the Rutherford Appleton Laboratory in the UK and the SNS spallation neutron source at Oak Ridge National Laboratory in the USA. If Mantid is used to perform the data corrections for a neutron spectrometer, then the algorithm SaveNXSPE in Mantid can be used to output nxspe files. Full details of how to use Mantid and the input/output for each algorithm are available at the Mantid web site [89].</p>
        <p>Alternatively, if the user can read corrected scattering data, associated estimated errors, and detector parameters into 
            <rs type="software">Matlab</rs> arrays, 
            <rs type="software">nxspe</rs> files can be written to file using the HORACE utility function 
            <rs type="software">gen_nxspe</rs>. Full details of the input argument definitions and array formats for this function are available on the HORACE web site [85].
        </p>
        <p>Appendix B. sqw files and objects sqw files and sqw objects contain the same information. They consist of two parts. The first consists of a number of header sections which contain meta information about the experiment: the detector information for the spectrometer, incident energy E i (or final energy E f if the spectrometer has indirect geometry), and crystal lattice parameters and orientation for each contributing run. The header sections also contain the bin boundaries and intensities (with the square of the estimated errors) in the bins of the Cartesian grid defined by the orientation of the plotting axes, along with the number of contributing detector-energy voxels in each bin. The second part contains Q , ω , the run index, the de- tector index, intensity, and estimated error-squared for every detector-energy voxel from each of the contributing runs. This section generally accounts for virtually all the disk space or memory occupied by the file or object. The voxel information is coarsegrain sorted on the Cartesian grid defined in the header sections so that all voxels in one bin in that grid occupy a contiguous block on disk or in memory. Note that the coordinate frame in which components of Q are stored is not in general the same as the plot axes, and the matrix transformation that links the two is stored in the header sections.Appendix B. sqw files and objects sqw files and sqw objects contain the same information. They consist of two parts. The first consists of a number of header sections which contain meta information about the experiment: the detector information for the spectrometer, incident energy E i (or final energy E f if the spectrometer has indirect geometry), and crystal lattice parameters and orientation for each contributing run. The header sections also contain the bin boundaries and intensities (with the square of the estimated errors) in the bins of the Cartesian grid defined by the orientation of the plotting axes, along with the number of contributing detector-energy voxels in each bin. The second part contains Q , ω , the run index, the de- tector index, intensity, and estimated error-squared for every detector-energy voxel from each of the contributing runs. This section generally accounts for virtually all the disk space or memory occupied by the file or object. The voxel information is coarsegrain sorted on the Cartesian grid defined in the header sections so that all voxels in one bin in that grid occupy a contiguous block on disk or in memory. Note that the coordinate frame in which components of Q are stored is not in general the same as the plot axes, and the matrix transformation that links the two is stored in the header sections.</p>
        <p>Generally it is not recommended to directly manipulate the contents of an sqw object because of the strong interdependence of the contents. Instead various functions are available to extract the header sections [head(objectName) and head_horace (filename)], evaluate functions of the plot axes or models for ω ( ) S Q, on sqw or dnd objects held in memory (func_eval, sqw_eval), extract the bin centers and data for bespoke manipulation within 
            <rs type="software">Matlab</rs> but outside HORACE (xye), and read and save sqw or dnd objects to disk (read_horace, save). Lastly, the plot data can be saved to disk as an ASCII file (save_xye). Full descriptions of all of these functions are on the HORACE web site [85].
        </p>
        <p>The developers welcome suggestions for additional functionality. Contact details are given on the HORACE web page.The developers welcome suggestions for additional functionality. Contact details are given on the HORACE web page.</p>
        <p>R.A. Ewings et al. / Nuclear Instruments and Methods in Physics Research A 834 (2016) 132-142R.A. Ewings et al. / Nuclear Instruments and Methods in Physics Research A 834 (2016) 132-142</p>
        <p>We are grateful to Ross Stewart, Tatiana Guidi, Rob Bewley, Helen Walker, Devashibhai Adroja, David Voneshen, and the many users of HORACE worldwide for comments and feedback about the program. We thank H.A. Mook for the loan of the iron crystal, and W.J.L. Buyers for the loan of the URu 2 Si 2 crystal. Experiments at the ISIS Pulsed Neutron and Muon Source were supported by a beamtime allocation from the Science and Technology Facilities Council.We are grateful to Ross Stewart, Tatiana Guidi, Rob Bewley, Helen Walker, Devashibhai Adroja, David Voneshen, and the many users of HORACE worldwide for comments and feedback about the program. We thank H.A. Mook for the loan of the iron crystal, and W.J.L. Buyers for the loan of the URu 2 Si 2 crystal. Experiments at the ISIS Pulsed Neutron and Muon Source were supported by a beamtime allocation from the Science and Technology Facilities Council.</p>
        <p>To generate the sqw file from which HORACE reads ω ( ) S Q, , neutron scattering data for each individual run and needs to be provided in one of two formats: the legacy ASCII spe file, or its replacement the HDF5 (Hierarchical Data Format) 
            <rs type="software">nxspe</rs> file. Two functions are available as part of HORACE to create sqw files from these input files, namely gen_sqw (which creates a new sqw file) and accumulate_sqw (accumulates data to an existing sqw file).
        </p>
        <p>The ASCII spe file stores ω ( ) S and associated error bars as a function of energy transfer, ω , for each detector in turn. In ad- dition to the set of spe files, HORACE requires an accompanying ASCII file which contains information about the location of the detectors in the spectrometer's reference frame, the par file. Although these ASCII format files have largely been superseded in favor of the nxspe format described below, such files are ubiquitous as the format in which historic data is saved, and areThe ASCII spe file stores ω ( ) S and associated error bars as a function of energy transfer, ω , for each detector in turn. In ad- dition to the set of spe files, HORACE requires an accompanying ASCII file which contains information about the location of the detectors in the spectrometer's reference frame, the par file. Although these ASCII format files have largely been superseded in favor of the nxspe format described below, such files are ubiquitous as the format in which historic data is saved, and are</p>
    </text>
</tei>
