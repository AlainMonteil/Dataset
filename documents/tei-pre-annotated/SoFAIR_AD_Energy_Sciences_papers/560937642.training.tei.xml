<?xml version="1.0" encoding="UTF-8"?>
<tei xmlns="http://www.tei-c.org/ns/1.0">
    <teiHeader>
        <fileDesc xml:id="_1"/>
        <encodingDesc>
            <appInfo>
                <application version="0.8.1-SNAPSHOT" ident="GROBID" when="2024-06-24T12:27+0000">
                    <ref target="https://github.com/kermitt2/grobid">A machine learning software for extracting information from scholarly documents</ref>
                </application>
            </appInfo>
        </encodingDesc>
    </teiHeader>
    <text xml:lang="en">
        <p>Building microgrids have emerged as an advantageous alternative for tackling environmental issues while enhancing the electricity distribution system. However, uncertainties in power generation, electricity prices and power consumption, along with stringent requirements concerning power quality restrain the wider development of building microgrids. This is due to the complexity of designing a reliable and robust energy management system. Within this context, hierarchical control has proved suitable for handling different requirements simultaneously so that it can satisfactorily adapt to building environments. In this paper, a comprehensive literature review of the main hierarchical control algorithms for building microgrids is discussed and compared, emphasising their most important strengths and weaknesses. Accordingly, a detailed explanation of the primary, secondary and tertiary levels is presented, highlighting the role of each control layer in adapting building microgrids to current and future electrical grid structures. Finally, some insights for forthcoming building prosumers are outlined, identifying certain barriers when dealing with building microgrid communities.</p>
        <p>Buildings are responsible for more than 40% of primary energy consumption and nearly 28% of total direct and indirect CO2 emissions [1]. In this context, the concept of building microgrids [2]- [5], in which distributed RESs and storage are installed near to power consumption, has become more attractive due to the reduction of total energy losses in transmission lines and the decrease in main grid dependency. Nevertheless, complete RESs widespread in buildings is restrained by the adversity of integrating RES in the current electricity market structure, due to early gate closure times, low-time resolution of hourly trading products and electricity prices based on fossil fuel tariffs [6], [7]. All these aspects place RESs in a disadvantageous position compared to fossil fuel power plants regarding market revenue risk, and thus, do not encourage their wide investment enough [8]. Furthermore, unlike traditional fuel power plants and other dispatchable units in which the energy generation is fully mastered and always considered available, RESs are non-dispatchable units that cannot be fully controlled due to power production uncertainties induced by their dependency on weather conditions [9]. Consequently, BMGs create a complex environment due to the difficulty of designing a unique building EMS (BEMS) capable of ensuring both a reliable operation system, i.e. complying with power quality standards [10], and optimal trade with the electricity market to ensure its operation economically advantageous [11], [12]. However, few studies deal with the electricity market trade and power quality issues [13]- [15]. Most of them deal with each MG concern separately without considering any possible conflicting objectives when they are put together. In order to tackle as many BMG requirements as possible, the HC structure has been heavily adopted [9], [16]- [18], but the complete structure with primary, secondary and tertiary levels with electricity market participation are rarely studied. The main interest of the hierarchical structure is that it makes it possible to handle multipled objectives that are sometimes conflicting and not in the same time scale, such as increasing active power injection without degrading the islanded MG frequency [19], assuring safe power-sharing while keeping the level of voltage unbalance within the standard boundaries [20], maximising the profit from electricity market while ensuring the power balance [21], or reducing power consumption without penalising residents comfort [13], [22]- [25].</p>
        <p>The aim of the HC is to optimally assign each dispatchable unit inside the BMG with power references. Its primary purpose is to maximise the RESs exploitation and minimize the power dependency on the main utility [4], [26]- [28] while avoiding unsought measures, like the curtailment of renewable sources [29] and load shedding [30]. Notably, without any dispatchable unit, the power balance cannot be satisfied except by purchasing electricity from the main grid. As demonstrated in [28], [31], the lack of battery exploitation makes the total MG cost always higher than scenarios where the battery's capacity is larger. For this reason, in the literature, the fundamental and most common approach in smart buildings is to manage an appropriate ESS [32]. Consequently, most EMSs incorporate ESS SoC constraints as long as enhancement of battery lifetime in their objective functions, as studied in [11], [33], [34].</p>
        <p>Generally, energy management in a BMG is conceived with a single ESS and with a horizon of one day-ahead. For instance, in [35], [36] fuzzy logic was used in a PV-battery MG, whilst in [14], [37] a rule-based algorithm to manage a WT-PV-battery was used. On the other hand, in [38] a MAS structure with PSO and fuzzy logic was conceived to coordinate a BMG considering internal comfort while reducing costs. Likewise, [34], [39] used metaheuristic methods with a small MG, whereas the authors of [40] used stochastic algorithms to tackle the uncertainties of electricity prices and power generation. Based on load profile, hybrid ESSs are also envisaged in BMGs, as highlighted in [41]. Despite being less common in BMGs, supercapacitors and batteries can be designed to reduce the stochastic power generation of RES, soften fast peak of consumption and regulate the frequency when operating in island mode [42], whereas fuel cells can be suitable for handling seasonal power variability [43]. There are many strategies to manage hybrid ESS, such as MPC for managing fuel cells and batteries [33], [44]- [46], PSO [47] and GA [11], [48]. Some studies also consider the batteries of PEVs in MG energy management, such as [44], [49] and [50]. In [44] and [50] a two-stage controller was used to ensure MG stability in the first stage and economic dispatch in the second. Similarly, in [4], a hierarchical MPC was designed to use PEV batteries to compensate the power imbalance between generation and consumption, provided that batteries were charged at the end of the working day and considering their random arrival and departure time.</p>
        <p>Considering BMG concerns, the objective of this paper is to review different strategies in terms of HC structure for BMGs detailing each control level, as well as the trends in the electricity market for buildings. Hence, the remainder of this paper is organised as follows. Section 2 presents some BMGs demonstrators around the world. Section 3 lists the most important BMG control requirements. Section 4 explains the three most common HC structures found in the literature, as well as their advantages and disadvantages. Section 5 details each HC layer by stating their objective. Section 6 explains the existing command strategies for BMG regulation. Section 7 provides an extensive comparison of the most usual energy management algorithms in MGs. Section 8 clarifies BMG perspectives for the near future. Finally, Section 9 concludes the review paper.</p>
        <p>International directives worldwide have conducted research aiming for new technologies to pave the way toward sustainable buildings with high thermal and electrical efficiency, also known as the NZEB plan [51], [52]. A successful path aimed at NZEB targets should be accompanied by technological breakthroughs following the well-defined order of priorities highlighted in [51] and pictured in Fig. 1. With the aim of making all new buildings NZEB within the next decades, many demonstrators have been built all around the world. In [53], more than 400 buildings were analysed by pointing out their main features to attain the NZEB requirements. Similarly, the authors in [54] summarised 74 academic papers that refer to real NZEBs, whereas [55] analysed 600 real NZEBs found on web platforms like Zero Carbon Hub [56] by dividing them into five clusters depending on temperature, ownership and site location.</p>
        <p>However, real NZEB energy management strategies lie much more on thermal efficiency by implementing passive solutions rather than active methods with on-site power generation. Passive strategies, which include thermal insulation and natural lighting architectures, are cheaper and faster measures to improve building efficiency, because energy demand for thermal control represents 59% of total building energy demand, as depicted in Fig. 2 [1]. According to [51], on-site electricity generation through RES combined with ESS exploitation is essential to achieve NZEB requirements. Otherwise, the buildings will not reach the expected rates for electric selfconsumption and self-coverage [57] in one year.</p>
        <p>Low thermal energy needs for heating, cooling and hot water Real implementations with active solutions are focused on building-integrated PVs as pictured in Fig. 3, in which their energy surplus is either fed directly into the grid (photovoltaic systems) or stored in thermal collectors (thermal-solar systems), such as those mentioned in [53], [58]. In these studies, electric ESSs are not usually considered due to the complexity of ESS energy management algorithms, expensive installation costs and the need for additional power converters. Demonstrators employing both RESs and ESSs are transitioning from the research and development stage to full market accessibility.</p>
        <p>Although most BMGs are usually reported either on the laboratory [14], [24], [35], [44], [46] or demonstrator scale, as the Pixel Building in Australia [59] or Pearl River Tower in China [60], some companies are starting to offer residents the possibility of installing their own home batteries. Companies like EDF [61] and Naked Solar [62] have started integrating electric ESS into buildings, but it is still too expensive for widespread implementation. A number of relevant real BMGs test beds with electric ESS are summarised in Table 1, where most of their BEMS are designed hierarchically, by superposing a central EMS on distributed local controllers for managing BMG power flows. Since most BEMS demonstrators tend to be structured hierarchically, in this paper a comprehensive review of hierarchical energy management algorithms for BMG equipped with electric ESS will be presented.</p>
        <p>Summary of recent studies that implemented the energy management system in building microgrids with electric energy storage system</p>
        <p>Pearl river tower Super-tall commercial building WT, PV</p>
        <p>Building efficiency is improved by using heat recovery strategy. Due to jurisdiction constraint, the excess of energy cannot be injected to the main grid. Therefore, the surplus of energy is stored in hydrogen tanks, and WTs are controlled accordingly.</p>
        <p>Thailand, 2016</p>
        <p>Developing a suitable controller for BMGs is one of the most significant challenges for buildings to become active prosumers (both producers and consumers) in the current electricity market [5], [22], [67] and achieve the targets defined for NZEBs. The main difficulty of BEMS is to manage multiple variables that are not on the same time scale. To understand the main control objectives related to HC for BMGs, the most relevant requirements are detailed underneath, highlighting their respective usual time frame:</p>
        <p>The difficulty of power-sharing consists of optimally assigning each DG with respective active and reactive power (in AC MGs) so that the load demand is satisfied without overloading a specific DER and without degrading the MG bus voltage and frequency ( &amp; ) levels. Power-sharing is usually implemented in a distributed way by droop control strategies, because of low-bandwidth communication requirements and high flexibility concerning plug-and-play MG devices [18], [68]- [72]. A comprehensive review of droop control strategies is summarised in [73]. However, centralised architectures have also been envisaged due to more accurate power-sharing results and less &amp; deviations. Master-slave [74], [74], [75] and concentrate methods [76] are the most usual centralised power-sharing strategies found in the literature. Further discussion about power-sharing control algorithms are detailed in paragraph 5.1.2.</p>
        <p>Controlling HVAC systems can enhance a building's efficiency and reduce costs in terms of purchasing electricity from the main grid while maintaining residential comfort, as studied in [13], [24], [77]. Generally, indoor comfort is evaluated based on the Predictive Mean Vote index and controlled with respect to ASHRAE [78] or EN15251 standards. However, designing a thermal model for real buildings may be cumbersome, leading to simplified resistance-capacitance models [13], [45] or other thermodynamic models [24], [50]. Another approach is to use software assistants (e.g. 
            <rs type="software">EnergyPlus</rs> and 
            <rs type="software">TRNSYS</rs>) to simulate the complex thermal dynamics of an entire building [77]. Alternatively, gray-box models, which consider real data and theoretical models, have also been studied [79].
        </p>
        <p>BMGs can be modelled on different scales depending on their electric capacity, operating either as independent buildings (i.e. residential buildings with a capacity of 1kW -10kW), communities or high-capacity buildings (i.e. commercial buildings with a capacity greater than 10kW) [5]. Depending on its size, the grid-connected building/community MG can offer some ancillary services to the grid for &amp; regulation at PCC. For instance, [13] and [14] studied the scenario where individual buildings can support the external grid through ancillary services or load-following mechanisms to respect the grid's constraints at PCC. However, when connected to weak grids, such as isolated communities forming an off-grid system, ensuring power-sharing among DGs will not necessarily ensure &amp; regulation at the MG CB. Due to the cross-correlation between active/reactive power and voltage/current, there will often be a voltage deviation between the voltage reference and that measured at CB. A detailed review of the main strategies to properly regulate the &amp; is summarised in [80] and in paragraph 6.1.</p>
        <p>The BMGs prime interest is to exploit as much as possible RESs and trade in the electricity market only in emergency situations to achieve the autonomy indicators of self-consumption and self-coverage [57] imposed by regional grid regulations. Consequently, BMGs' PV panels and WTs are normally controlled via MPPT algorithms to extract the maximum power independently of external weather conditions [81], [82]. As a result, the power dispatch in BMGs is concentrated on the coordination of their ESSs, DSM and determining the amount of energy to be exchanged with the main grid.</p>
        <p>Depending on the BMG's electrical architecture, the power dispatch must be designed differently. For instance, contrary to DC and AC BMGs, the EMS of hybrid BMGs must manage the power flow between AC and DC buses through bidirectional AC-DC power converters to guarantee power quality in both buses. Likewise, there are differences in the power dispatch when connected or disconnected from the main grid. In off-grid buildings, batteries are mainly used to assure power quality inside the MG. Meanwhile, in grid-connected systems, ESSs are normally used to shift the peak demand according to some demand-response incentives. Moreover, when connected to the grid, the BMG can rely on external grids to satisfy its demand, by participating in the electricity market [8], [21], [83], [84]. A more detailed explanation about building interaction with external grids is discussed in section 5.3.</p>
        <p>When multiple sorts of ESSs (i.e. hybrid systems), and dispatchable and non-dispatchable units are installed inside the BMG, there are numerous ways of satisfying the load demand depending on how the BEMS coordinates the DGs. Nonetheless, all possible solutions are not necessarily considered as optimal in terms of economic or environmental aspects. In this case, the power dispatch can be formulated as an optimisation problem that considers the cost of each DG, the fatigue of energy storage systems, as studied in [26], [33], [85], and/or the gas emissions as investigated in [34], [43]. Power dispatch optimisation lies in a multi-objective problem that is usually solved using the Pareto frontier to determine the best compromises among various possible solutions [49]. A critical review of different EMS methods for power dispatch in MGs and existing algorithms are summarised in [15] and Section 6.</p>
        <p>Energy demand is classified either as elastic or inelastic [86]. Inelastic demands are those that need to be supplied immediately, such as lighting and domestic equipment (e.g. televisions and computers). Consequently, they cannot be controlled directly by the BEMS. Meanwhile, elastic demands have energy requirements that have to be met within a certain deadline, such as dishwashers, water heaters, air conditioners and PEVs [4], [13], [23], [87]. This kind of load can be curtailed or shifted to satisfy the power balance. Alternatively, implementing DR programs can be used to maintain a system's reliability and enhance BMG flexibility during peak load periods by either financial incentives or education programs as reviewed in [88].</p>
        <p>The control design of BMGs must respect electrical standards to guarantee both inhabitants' safety and grid power quality. In [89], some important BMG standards were discussed, while [90] summarised relevant electrical indicators that the controller must monitor in DC MGs. In AC MGs, the load-MG coupling must respect the constraints of power quality defined by standards, considering harmonic generation [91], [92], voltage unbalance [93], [94] and &amp; regulation [10], [95], [96]. A collection of the main electrical standards applied in Europe, and that is essential for BMG controller design are summarised in Table 2. Depending on BMG capacity and electrical architecture, different standards may be considered, as summarized in [89] and detailed in Table 3.</p>
        <p>Power quality burden and the number of power converters are reduced in DC BMGs, whereas grid synchronisation and frequency regulation are major concerns in AC BMGs. Consequently, DC BMGs are usually deployed in remote areas or low capacity buildings, like those in [14], [37]. However, their reliability is reduced when connecting to the main grid since they rely only on the interlinking bidirectional converter, contrary to multiple inverters in AC BMGs. Therefore, hybrid coupled MGs have been envisaged for grid-connected buildings [2], [25], [97], because they can include both the simplicity of DC buses, and the high flexibility and reliability of AC buses when connecting to the main utility. Functions for the control level associated with the proper operation of the EMS that is common to all microgrids, regardless of topology, configuration, or jurisdiction.</p>
        <p>[102]</p>
        <p>Rules for the communication between BMG and substation as long as between intelligent devices inside BMG. [103] Legend: *These standards need to be purchased to have full access.</p>
        <p>When a grid fault happens, the MG must disconnect from the main grid to avoid damage to electrical devices and possible disturbances to the main grid. In this context, grid-connected MGs must be capable of detecting grid faults, ceasing the operation of power converters, and finally operating in island mode [10]. Consequently, gridconnected MGs are also designed with either passive [104] or active islanded detection systems [105] as well as dedicated control algorithms for regulating the electrical transients when commuting between operation modes [97]. However, some efforts have been made to propose a single controller for both modes of operation, such as the fuzzy logic controller proposed in [106] to predict increases in current and voltage and limiting the power supply of DERs. In [97], a pre-synchronisation system based on angle compensation was proposed as an alternative to the conventional phase lock loop, allowing a single control for a master-slave converter topology [107] to be used when operating in either islanded or grid-connected modes. As consequence, island detection becomes less critical and the transient response is enhanced once the commutation between controllers is no longer required.</p>
        <p>After recognising the major requirements of a BMG, it is noteworthy that all these concerns must be accomplished in parallel, even though they are not on the same time scale as illustrated in Fig. 4. For instance, due to the fast response of power converters, frequency and voltage regulation, power-sharing and island detection, must be satisfied almost instantaneously (a few milliseconds). On the other hand, depending on the power quality issue, it might be processed within a few milliseconds to one minute. Additionally, power dispatch can be dealt with a few minutes, whilst economic dispatching and market participation are usually deployed from every few minutes to one hour.</p>
        <p>The smartness of HC lies in dividing a complex problem into different time-based chunks (e.g. k , k , k and k in Fig. 5) that are interconnected by exchanges of some variables from lower to higher hierarchical levels (or viceversa) that is normally fulfilled via external wireless-communication or direct communication-link protocols [100], which are further detailed in Table 4. The communication protocol must be chosen in accordance with control design requirements concerning latency and baud rate as outlined in IEC6185 standard (Table 2) and • Further explanation about EPA: [103].</p>
        <p>Studies that used SCADA: [24], [109], [110] Serial Therefore, through external communication, the exchangeable variables among hierarchical levels are used to ensure the power balance (P , P and P ) or to optimally assign power references (P ! ) toward the distributed Local Controllers (LCs) of each power converter, as illustrated in Fig. 5. The BEMS can also implement DSM through DR mechanisms to shift load demand by determining equipment on/off signals (s #$% ) or indirectly controlling the building's power imbalance by changing its dwellings' behaviour through financial incentives [88]. DR incentives are usually based on the analysis of real-time building net energy that was collected by the building smart meter and processed remotely with the huge amount of other forecasted data coming from cloud services [111], [112] or building community aggregator [13], [21]. Consequently, data collection modules, such as smart connected devices (e.g. smart meters and sensors), also known as IoT components along with weather and load forecast data analysis play an important role in BEMS [111], [112].</p>
        <p>The HC as a whole is regulated by relying on local measurements acquired by the primary control at PCC or CB, which comprise voltages and currents at each converter output. Notably, the HC diagram depicted in Fig. 5 is a simplified architecture that can be enhanced by adding sharing variables like total harmonic distortion [91] or voltage unbalance factor [93] to address power quality issues or temperature sensor signals to regulate the HVAC system [13], [24], [77]. In the literature, different HC approaches are presented such as the traditional PI-hierarchical control [113], hierarchical multi-agent system [114], [115], hierarchical predictive control [44], [116] and stochastic HC [21], [117]. Depending on MG size, communication and computer technology, a HC MG can be designed in centralised or distributed fashion [118], or a combination of both forming hybrid MGs [119]. As will be explained in the following three paragraphs, HC classification is based on how the secondary control layer, also known as the supervisory control system, is designed.</p>
        <p>CHC consists of one master control entity and other slave low levels -see Fig. 6 ( a). It relies on huge data storage systems and high-performance computers to construct a dedicated central controller that communicates extensively with the controlled units. Therefore, CHC enables high computational cost algorithms to be used. For instance, [21], [120] managed MG uncertainties through a CHC in which multiple scenarios were analysed before performing the optimal power dispatch. Correspondingly, [11], [34], [121] employed metaheuristic algorithms with calculation of Pareto optimal solutions in a multi-objective cost function. To reduce the computational demand for CHC architecture, cloud services empowered with data science techniques and vast forecast databases have also been envisaged in BMG environments as reviewed in [111], [112], but security aspects restrain industries from embracing cloud computing technologies. The main advantage of CHC is that it holds the control intelligence that considers the MG as a whole. Consequently, it does not depend on complex CA [114] to build global knowledge of the MG, making the design of centralised BEMS easier than distributed architectures. Therefore, relying on trustworthy state variables allows simple algorithms to be used in MG energy management, such as fuzzy logic [35], [123] and rule-based [37], [84].</p>
        <p>MGs covering extensive geographic areas, such as the agglomeration of multiple BMGs, make centralised MG control architectures infeasible due to extensive communication and computational costs. Nonetheless, in small environments such as hospitals, schools and small communities, a centralised MG can be suitable. Another drawback of CHC is the weakness against SOPF in communication, which can lead to a complete collapse of centralised systems, while only an occasional and transient loss of performance in distributed architectures [91], [124]. In this context, Software Defined Networks have been emerging as a promising communication architecture to improve the robustness of CHC in BMGs regarding self-healing properties when in contingency situations and to enhance its reliability by reducing the amount of data transfer, as reviewed in [108] and implemented in a MG testbed in [125].</p>
        <p>In DHC, illustrated in Fig. 6 (b), each LC actuates individually in each DER, without relying on any command coming from a central controller as in CHC. Each individual best-evaluated solution is determined locally based on local measurements and on the sharing of information among all the MG's LC through peer-to-peer communication, standardised by IEC 61968 (for a single BEMS) and IEC61850 (for interoperability between BMGs). In this kind of topology, full knowledge of MG state variables is built based on average CA. Due to incomplete information about the overall MG status and delays caused by CA, centralised topologies have typically a higher performance than distributed ones [126].</p>
        <p>Massive research has been conducted in an attempt to improve the performance of distributed architectures through CA [124], [127], to achieve information awareness comparable to that of centralised controllers. There are different strategies to implement DHC. For instance, in [36], the voltage regulator uses a noise-resilient voltage observer to estimate the global average voltage which is used to adjust the local voltage set point to provide global voltage regulation through CA, while in [87] MASs were used to manage an isolated polygeneration MG using partial load shedding optimally. HHC is a combination of distributed and centralised controllers as depicted in Fig. 6 (c). Local and global optimisations work in cooperation to achieve the MG's optimal point of operation. The local controllers are organised in groups so that the central controller's intelligence is split into smaller computation resources. HHC implementation is more complex than CHC since coordination among central controllers is mandatory to build the overall MG knowledge but delay time in communication is less harmful than in DHCs. Similar to DHCs, the likelihood of SPOF in HHC is lower than fully centralised controllers, because each central controller can also operate independently in the case of contingency situations. Therefore, the scalability, flexibility, robustness and cost of investment of HHC is more advantageous than DHC and CHC in large environments [119].</p>
        <p>In the context of BMGs, the HHCs were evaluated for managing BMG communities when importing and exporting energy among multiple prosumers under the peer-to-peer electricity market concept. In [128], the IEEE 14-bus was divided into three communities that trade electricity amongst each other to reduce energy exchange with the external grid. Similarly, in [129], the power flow inside each household equipped with PV array and batteries is managed through a central controller to maximise its self-consumption rate, while peer-to-peer control configuration coordinates the energy trade with neighbouring microgrids and the external community grid in a distributed manner.</p>
        <p>Notably, a single control is not capable of solving all BMG concerns simultaneously. Hence, the hierarchical architecture is considered a suitable configuration to be used in BMGs because it allows multiple variables to be controlled almost independently thanks to its inherent cascade structure [70], [118]. It usually has three control levels -namely primary, secondary and tertiary control -in which each one holds a dedicated responsibility regarding the overall MG interest as depicted in Fig. 5 with further details bellow.</p>
        <p>The primary control is responsible for interacting directly with power converters, either in grid forming or grid following configurations [107]. This hierarchical layer sends control at intervals of several milliseconds to the power electronic devices to stabilise the &amp; at MG internal buses, perform islanding detection, accomplish power-sharing among different DERs and address some of the power quality issues. Since DERs are physically distributed and the control is based mainly on local measurements, communication in this control layer tends to be minimal or inexistent. Despite not being totally standardised, the primary control is divided in two: an inner loop responsible for regulating the power converters' voltage and current output, and the outer loop in charge of ensuring safe and correct power-sharing.</p>
        <p>Although the inner loop has been exhaustively studied in the literature [10], [73] to the point that normally the converters have already been equipped with built-in output current and voltage controllers that are predefined by the manufacturer, a great deal of research is still being conducted. The main topics that are still subject to research are improving the robustness against topological uncertainties, enhancing transient response [71], reducing unbalances and harmonics [91], [92], developing control schemes plans capable of operating in both grid and islanded modes [106] and providing a smooth transition for MG operation modes [130].</p>
        <p>Moreover, alternative methods to generate adequate digital signals for the converter's power transistors have been developed. With the MPC adopted in [131], [132], the limitations of PWM have been overcome since the output of the MPC generates the control of the power switches directly. This novel strategy allows the inclusion of various constraints and multiple objective functions, improving converter flexibility and reliability. Alternatively, PI controllers can also be substituted by proportional-resonant controllers to reduce the harmonic current circulation and improve the transient behaviour of current control loops [87]. Additionally, robust controls can also be used to improve the transient response and robustness against any minor disturbances in terms of frequency like in [133] that used H-infinity control.</p>
        <p>The power-sharing control might be classified based on its communication aspect as either master-slave, concentrated or distributed approaches [134]. The main advantages and disadvantages of each topology are summarised in Table 6 based on five relevant criteria. In the master-slave control, also known as communication-based control, the highest capacity DG is usually chosen as master (i.e. operation in voltage source converter) which controls the system's voltage and handles transient during system disturbances, whereas the slave inverters (i.e. operation in current source converter) follow the master to ensure power-sharing. On the other hand, in concentrated power-sharing techniques, the current sharing module measures the total current being consumed by the load (&amp; '()* ) at the PCC and determines throughout a central module the reference current of each DG, typically the average current calculated as &amp; '()* /,, where , is the total number of DGs connected to the common bus. Finally, distributed control, also called the noncommunication-based approach, requires each DG unit to regulate the output voltage and current while sharing active and reactive power. Among these topologies, distributed control based on droop is generally implemented because compared to other power-sharing strategies, it is more reliable and more flexible since it coordinates parallel-connected inverters of each DG unit based only on local sensed voltage and current at the PCC, and, therefore, it is considered suitable for the BMG environment. However, depending on the dominant characteristic of the line impedance, the droop coefficient changes, leading to high parameter dependency and system instability, that can be overcome by introducing virtual impedances as a feed-forward control loop [20], [70], [91].</p>
        <p>Additionally, the droop control has a slow transient response, a strong correlation between the output voltage and active power, poor dynamics at the time of disturbances compared to other methods. As highlighted in [73], [134], power-sharing with the conventional droop control always has a trade-off between &amp; regulation and load sharing. This conflict is due to the droop coefficients which determine the active and reactive power references based on the frequency and voltage sensed at the CB. Variants of the traditional droop control were developed to tackle but not eliminate this trade-off, such as adaptative droop controls [73], [134], robust droop control strategy [72] and online droop parameter determination based on output active and reactive power [69]. Another approach is to add a secondary control layer that changes the set-points of the units using low-bandwidth communication as proposed by [19], [135].</p>
        <p>In contrast, communication-based approaches can handle power-sharing and MG &amp; deviation better than droop control strategies. Although the cross-correlation between active/reactive power and frequency/voltage still Topology Criteria exists, it is decoupled through the division of converter roles in the case of master-slave strategies and strong data share among the MG units in the concentrated methods, enabling the primary centralised controller to determine accurate current and voltage references. They also allow embedding complex algorithms to reduce harmonic circulation and unbalance voltage easier than droop control approaches [80], [136]. Nevertheless, they are dependent on high-bandwidth communication links and are prone to SPOF because they contain no system redundancy. Although these methods are more expensive than droop control and sometimes impracticable in large environments, they can ensure power-sharing accurately without needing an additional secondary control layer or adaptative strategies, and thus, can be suitable for BMGs.</p>
        <p>The secondary control is responsible for correcting the voltage and frequency deviations that have not been solved by the primary control. This control layer is also considered as a moderator between the third layer and the primary layer, correcting any power mismatch between the optimisation upper reference signals and real MG measurements as stated in [35]. The optimal power references coming from the upper layer are not necessarily compatible with the instantaneous power available in the real system on account of differences in the time scale. As a result, the secondary level tries to follow the upper reference by sending modified power references to DERs to keep the MG reliable and economically efficient while avoiding voltage and current violations [11]. In this context, the secondary control can also be formulated as a redundant optimisation problem to achieve greater accuracy in the final result [39].</p>
        <p>When the secondary control layer is designed to calculate optimal power references toward the primary control, it assumes a partial role of BEMS, which is responsible for sending switch-on or turn-off commands (-'()* in Fig. 5) to each programmable load and set-points for dispatchable DER for next periods. The BEMS takes its decisions based on its inputs that include the battery SoC, prediction of non-dispatchable generators, weather forecast, DERs maintenance costs, energy price estimations, and operational limits of electrical components. Since the value of signals for load curtailment decisions, the operation state of generator units and the PV disconnection decisions are discrete variables, and reactive and active power outputs of generators and bus voltage magnitudes are continuous variables, the BEMS becomes a complex optimisation problem. This kind of problem is normally written as an MINLP that can be simplified into an MILP [137], by using Taylor series first order expansion and replacing nonlinear variables by linear parameters. However, other studies considered the energy management problem as an MILP model directly as in [49], [138] and [35]. Further details about the secondary control algorithms are outlined in Section 6.</p>
        <p>Tertiary control is the highest and slowest control level in the HC, and defines the optimal active and reactive power references of each DG, and how much energy and at which price the MG is willing to trade with the electricity market to satisfy the power balance between load consumption and power generation, by considering economical and meteorological prediction data [50]. Like the secondary control layer, it also performsenergy management, but in slower time samples on its constraints and objective functions. Although the power dispatch in the secondary layer is more concentrated on power quality and &amp; regulation, the power dispatch in the tertiary control focuses on BMG economic aspects, highlighting electricity market participation, management of spinning reserves and ancillary services [139].</p>
        <p>To perform the optimal economic power dispatch, the tertiary control layer relies on accurate prediction data. In the literature, there are two different main approaches to estimate these: either by artificial neural network techniques as used in [36] or by autoregressive-moving-average model [4], [40]. However, innovative approaches have been used in MG predictions, such as Grey prediction [87]. It has low computation costs, since it combines mathematical RES models [139] with historical data. Therefore, the tertiary control level is endowed with powerful optimisation algorithms, such as those mentioned and discussed in Section 6. Moreover, this control layer incorporates thoughtful strategies to deal with the nuances of the electricity market. For that reason, in the following three paragraphs, a comprehensive definition and survey of the electricity market are detailed.</p>
        <p>The traditional electricity market is composed of three parts, namely generation, transmission and distribution sectors. The generation sector is composed of high capacity power producers, such as gas, nuclear, WT or PV power plants. Subsequently, the MO (composed of Wholesale Market &amp; System Operator) and the utility transmission embody the transmission sector, which is responsible for determining the clearing price and for delivering energy from generation to consumption, respectively. For further information, papers [31] and [140] explain how MOs determine marginal clearing prices for LSEs. Finally, the distribution sector is in charge of adequately delivering electricity to final consumers. Different MOs exist worldwide and each one acts in a particular region called a bidding zone, but most electricity markets are similar and can roughly be classified into three major markets [139]:</p>
        <p>• Daily market: This is in charge of matching the active power that will be consumed on the following day with the forecast load demand for a specific bidding zone. For that, each LSE sends its bids specifying the total amount of energy that it believes will be traded and its forecast energy consumption. Afterwards, the MO gathers all the multiple LSE information and runs a deterministic algorithm to establish the clearing prices (e.g. EUPHEMIA in Continental Europe).</p>
        <p>• Intraday market: Since the perfect active power match between consumption and production is not always satisfied by only day-ahead markets, intraday markets are opened all day long with the aim of solving these discrepancies, ensuring a reliable energy dispatch toward the load. However, its participation is only possible if the MG has traded on the daily market on that day. Moreover, Capacity Allocation and Congestion Management forces the intraday energy price to always be higher than the daily market price, to avoid any speculation and incite MGs to formulate reliable bids on the daily market.</p>
        <p>• Ancillary service markets: Contrary to the daily and intraday market that trade active power, the ancillary service markets are those that consider the reactive power too. Spinning reserves, non-spinning reserves, supplemental reserves, automatic generation control and black start units are the most common types of ancillary services.</p>
        <p>According to [8], the structure of the current electricity market is not totally suited to make the investment in renewable energy profitable. Consequently, the electricity market's standardisation is still being designed and may change over the coming years. Nowadays, many countries have adopted feed-in-tariff policies, in which the risk of the uncertain and competitive electricity market is hedged by long-term contracts to foster the RESs development. However, as stated in [6], this is a temporary measure that does not incite major changes to lead RESs worthwhile and to really adapt to the current electricity market.</p>
        <p>Hence, different branches of research have been conducted to provide the means for BMGs equipped with RESs to broadly participate in the electricity market. One tendency is to consider that smart buildings will be centrally organised throughout a common aggregator, which is responsible for trading electricity with wholesale markets and offer the final electricity price for all its dependent BMGs structured into a so-called MG community (MGC) [13], [14], [21], [67], [109], [141] as depicted in Fig. 7. This structure can reduce the risk of price oscillation for small prosumers and enhance the profit of both consumers and aggregators [141].</p>
        <p>It is essential to highlight that MGCs with an aggregator are similar to the current electricity market but with small power capacity. Basically, prosumers send to the aggregator their forecast load consumption for one day-ahead, as well as their electricity bid (purchase or sell). Thereafter, the aggregator buys (or sells) electricity from the MO at wholesale market prices and sells to (or purchase from) prosumers in the MGC at retail market prices. The authors of [141] and [84] proposed an algorithm to determine the optimal retail price based on the wholesale electricity price to improve the profit of aggregators without harming prosumers' revenue. In addition to trading electricity with the main grid, MGC allows neighbouring prosumers to exchange electricity among themselves, as studied in [21] and [83], in which the BMG can purchase either from the main utility at wholesale prices or from the MGC at lower retail prices. Similarly, in [21], [67], [109] considered that individual prosumers could use the common infrastructure installed inside the MGC, such as community ESS (CESS) and community controllable distributed generator (CCDG) at different prices. The community aggregator interacts with distributed system operators (DSOs) to trade electricity and offer some ancillary services to the main grid, that is transmitted to final consumers through a DR signal, as studied in [13] and [14]. Depending on the building's capacity (e.g. commercial buildings), it can trade in the electricity market directly, without an aggregator, as discussed in [50].</p>
        <p>Unlike this topology, [67], [128], [129] made a business plan for the early concept of peer-to-peer electricity trading by evaluating the possibility of direct interaction between market participants without considering a third party's involvement, in other words, without an aggregator, as illustrated in Fig. 8. In a more microscopic perspective, authors of [52] structured a framework of individual building interaction with external grids based on the concept of NZEB in which weighting factors are determined to define a unique measure for many types of energy carriers inside a building, coming from PV arrays, batteries, electric vehicles, combined heat power, gas and hot water.</p>
        <p>Concerning BMGs inside a CMG, many studies model the electricity market throughout a fixed electricity price profile with a time step of one hour, like [4], [35], [39], [40], [48], [50], [142]. To optimally trade on the electricity market, centralised tertiary control is envisaged, which considers daily electricity prices and receives the load consumption and power generation to estimate any power imbalance throughout the day to be covered by the electricity market exchanges. One simple and safe way to interact with the electricity market is to achieve a high index of self-consumption by penalising any electricity trade as adopted in [12], in which no profit is made by selling electricity, since it is sold at a minimum price and purchased at a maximum price. In [142], a MPC controller was designed to formulate optimal bids toward the Spanish electricity market to reduce economic penalties by minimising the deviation between power production and power committed in the electricity pool. Since the electricity market is a competitive environment in which MOs and local power producers wish to maximise their own revenue, in [140] implemented competitive MAS empowered with Q-learning in a complex bus with hourly time-varying load data profile. Contrary to most studies, in [117] the three electricity markets were modelled in a virtual WT power plant, concluding that the MG could make more profit trading with the imbalance settlement and on ancillary services markets than on daily and intraday markets. Another well-clarified approach to participate in the daily and intraday electricity markets is to structure a cascade tertiary level divided into different time scales as proposed in [33], in which the errors introduced by a long prediction horizon were reduced.</p>
        <p>This section details the main algorithms for &amp; regulation in the secondary control and discusses the main algorithms for power dispatch in both secondary and tertiary control levels. All these algorithms are summarized in Table 7, where they were grouped into five different categories: metaheuristic, deterministic, predictive control, artificial intelligence and stochastic &amp; robust algorithms.</p>
        <p>Deterministic algorithms for &amp; regulation are characterised by low computational costs and ease of implementation. In the literature, PI controllers and fuzzy logic are the most common deterministic approaches. For instance, the PI controller is adopted in [42], [71], [113], in which the MG bus voltage is measured and small &amp; corrective variations are sent back to the primary control to regulate them in the primary control layer. Concerning fuzzy logic, [106] and [143] proposed a fuzzy-based control capable of determining small frequency and voltage step corrections to improve the performance of droop control, diminishing any mismatch in the common bus without heavy communication links. Likewise, in [144], voltage control is conceived based on the combination of fuzzy control with gain-scheduling techniques to achieve both power-sharing and energy management. However, the foremost drawback of fuzzy control is that it is too dependent on pre-defined knowledge of the system plant and experimental procedure to design the most suitable membership functions, which may reduce its flexibility and robustness.</p>
        <p>Model predictive control for &amp; regulation is generally conceived centrally. In [145], a centralised MPC coordinates reactive power and regulates the MG voltage in a critical load bus voltage. Similarly, in [146], a twolevel MPC was designed, including a Voltage MPC for autonomous operation to regulate the capacitor voltage of an AC-DC converter and a Power MPC for grid-connected mode with the aim of maintaining the DC bus voltage stable while exchanging reactive power with the main grid. However, not only is centralised MPC possible. In [96], a distributed MPC was implemented in an isolated MG, in which the frequency regulation and economic costs were formulated as a unique objective function.</p>
        <p>Summary of secondary and tertiary control algorithms 6.2. Optimal power dispatch</p>
        <p>Concerning metaheuristic approaches, GA, which is inspired on Darwin's theory of survival of the fittest, is commonly applied to BEMS optimisation. It has the advantage that it can escape from local minima, but its complexity increases with the number of parameters. For instance, in [34], minimisation of the cost of power generation and maximisation of the useful life of lead-acid batteries in a standalone WT-PV-diesel-battery MG system were achieved through the solution of a multi-objective optimisation problem using the non-dominated Sorting genetic algorithm.</p>
        <p>One of the biggest challenges faced by GA is in the mutation and crossover steps that violate constraints. To overcome this, the authors of [11] proposed a priority-based initialisation of the GA population and simulated binary crossover strategy with a semi-probabilistic mutation method to reduce the number of constraint violations.</p>
        <p>. &amp; / regulation Secondary Control Deterministic PI controller [42], [71], [113] Fuzzy Logic [106], [143], [144] Predictive Control MPC [96], [145], [146] Power dispatch Secondary and Tertiary Control Metaheuristic Genetic Algorithm [11], [34], [48] Particle Swarm Optimization [47], [85], [121], [147], [148] Ant Colony Optimization [39], [149] Simulated annealing [150]- [152] Differential evolution [153]- [155] Deterministic Fuzzy Logic [36], [38], [123] Rule based [14], [37], [87] Predictive Control MPC [44]- [46], [156] Artificial intelligence Reinforcement learning [84], [157]- [160] Stochastic &amp; Robust Scenario generation [21], [40], [120], [161], [162] Alternatively, still concerning the constraints using GA, some studies used non-linear penalties in the objective function to reduce the complexity of optimisation like in [48].</p>
        <p>Another metaheuristic optimisation algorithm is PSO. It consists of an evolutionary agent-based technique which simulates the social behaviour of how a swarm moves in search of food. Among the advantages of PSO, fast interaction and convergence, ease of implementation and few parameters to be tuned can be highlighted. However, PSO can be disadvantageous when the objective function has many dimensions because of its tendency to fall into local minima due to loss of diversity. To tackle its drawbacks, the traditional PSO, which relies on fixed particle velocity limits, inertia, memory and cooperation weights, has been replaced by modified PSO that consider dynamic and diverse velocity to speed up the search process [147].</p>
        <p>Evolutionary PSO [148], Adaptive PSO [47] and hybrid-PSO [147] are innovative alternatives to traditional PSO that modify the intrinsic PSO parameters based on mutation, bad experiences and stochastic approaches to improve the diversity of searching process and enhance the likelihood of finding the global minimum. In [85], PSO was designed to determine the day-ahead power flow of a community MG considering battery degradation and it was demonstrated that the algorithm can reduce the MG operation's costs under scenarios with electricity price variations and data forecast inaccuracy.</p>
        <p>Similarly, ACA is based on the behaviour of ants while searching for food. Each ant leaves a pheromone trail on the path from the nest to food. This pheromone evaporates with time, so that the other ants can reach the food by following the shortest paths marked with strong pheromone quantities. The study in [149] used ACA to determine optimal power dispatching in a MG while achieving minimum power loss and increment the load balance factor of radial distribution networks with distributed generators. In [39], multi-layer ACA was implemented in a two-stage EMS model aimed at minimising operating costs for island MG, in which the first layer deals with hourly dayahead scheduling, whereas the second layer carries out five-minute real-time scheduling.</p>
        <p>The ACA can find the global solution if the parameters are well-tuned. Since the pheromone evaporates and ants move pseudo-randomly depending on the amount of pheromone, the ant colony can adapt to noise and changes in the environment thanks to their tracking of pheromone. ACA is characterised by its simplicity because only a few parameters need to be set up to implement ACA, such as the number of ants, pheromone decay and pheromone update parameters. The biggest disadvantage of ACA is -like most metaheuristic methods -the theoretical convergence time and its probabilistic distribution are uncertain, so the prior analysis is not possible.</p>
        <p>Many other metaheuristic algorithms are also used in MG power dispatches, such as Simulated Annealing [150]- [152], Differential Evolution, Gravitational Search [163] and Artificial Bee Colony-based Algorithm [164]. For instance, in [153]- [155], the Differential Evolution approach was used to solve optimal power flow problem with multiple and competing objectives, like economic and environmental issues.</p>
        <p>Due to the complexity of power management, fuzzy logic can be an easy but not necessarily optimal solution to schedule battery charge and discharge according to the weather forecast, electricity prices and SoC of batteries as proposed by the authors of [36]. Fuzzy logic is also used in thermal comfort because of its simplicity, as in [38], which implemented hierarchical centralised 
            <rs type="software">MAS</rs> with a user interface to improve the internal comfort of residents using both fuzzy logic and PSO while reducing MG operating costs and minimising electricity purchases from the main utility. An interesting review on fuzzy logic and its hybrid approaches as used in the context of MGs can be found in [165].
        </p>
        <p>Contrary to metaheuristic algorithms, deterministic approaches such as fuzzy-logic and rule-based [14], [37], [87] methods are not considered optimisation algorithms [37] because the energy management in these cases is solved based on a priori rules or membership functions to choose the best action and estimate the parameters' values, which require a lot of empirical plant knowledge, leading to a complicated design step. However, some studies tried to use metaheuristic algorithms like GA to adjust the fuzzy logic parameters [123].</p>
        <p>Hierarchical MPC for power dispatch is usually divided into two stages. The upper stage performs the economical MPC that is responsible for computing economical optimisation [46], by managing electricity purchases and sales to the power grid, maximise the use of renewable energy sources and control the use of batteries. In contrast, the lower stage, generally implemented as a tracking MPC, is responsible for ensuring MG's stability by trying to follow the optimal references calculated in the upper level while regulating the &amp; [156]. In [44], a two-stage EMS using MPC was implemented in a grid-tied MG, which uses batteries of electric vehicles to ensure MG stability in the first stage and economic dispatch in the second stage.</p>
        <p>The difficulty of multilayer MPC is to manage different constraints and calculate the optimal references because, in practice, the optimal reference may be infeasible due to stringent constraints. To avoid this situation, slack variables can be introduced in the constraints or scaling the multiple objectives into priorities so that the constraints of the objective function with the lowest priority are more likely to be violated than important objective functions. Alternatively, in [45], the authors coordinated a modular multiparametric MPC by exploiting hierarchy levels of all MPC critical regions. This modular MPC for an office BMG was designed to achieve two different objectives. The first objective was to maintain temperature comfort in an energy-optimal way and the second objective was to maintain the cost-optimal energy balance of the MG.</p>
        <p>A powerful method to handle uncertainties is artificial-intelligence approaches because they can adapt according to disturbances in the environment. RL is an artificial-intelligence-based method that has been envisaged for EMS for MGs. RL is a non-supervised learning algorithm that drives the learning based on rewards or penalties evaluated on a sequence of actions taken in response to the environment dynamic. The main interest aspect of this method is that the controller results are improved over time because both the reward function and possible future scenarios are updated based on past experiences.</p>
        <p>In [157], Q-learning-based control with scenario construction was used to coordinate battery charging and discharging in a grid-connected MG based on past data. The results demonstrated that over the years, the performance of the MG was improved if new scenarios are no longer revealed. Other studies also proved that Qlearning can be enlarged in a future horizon, allowing more trustworthy decisions to be taken concerning load consumption and power generation fluctuations, as in [158], where the charging and discharging of batteries in a PV microgrid was decided based on 3-steps-ahead of a Q-learning algorithm using the Markov decision process.</p>
        <p>To increase the time horizon without increasing the computational cost burden, distributed and cooperative RL with a linear and dynamic approximation of Q values was proposed in [159]. If the horizon is not enlarged because of high computational costs, the actions are discretized and are normally predicted one step before, resulting in oscillating control signals that can be harmful to batteries durability, for instance. In order to mitigate this problem, fuzzy logic combined with Q-learning functions is used to provide a good approximation of Q-learning functions allowing them to be employed in continuous state-space problems and to smooth the control actions, as used in [160] in which a distributed MG through 
            <rs type="software">MAS</rs> with RL using the fuzzy-Q learning approach was implemented. The potential advantages of this method are that the dynamic and iterative estimation of Q values make the control system model-free and independent of a large amount of previous data, because it depends only on the instantaneous reward function and the Q value of the previous iteration.
        </p>
        <p>An obstacle faced by the BEMS is the uncertainties in the power generation of renewable sources of energy. In this context, stochastic-optimization-based algorithms can incorporate these uncertainties in the control model, leading to a more efficient control strategy. In [120], two-stage secondary MILP-based stochastic programming optimisation is proposed to handle the uncertainties of PV and WT generation and regulate the &amp; of an islanded MG. In the first stage, random scenario generations using the Monte-Carlo Simulation and Roulette Wheel Mechanism and scenario reduction by eliminating low probable and similar scenarios were conceived. Afterwards, in the second stage, the optimisation algorithm based on the MILP model is executed based on the probabilistic scenarios in the first stage. Similarly, in [21], the power balance mismatch provoked by the uncertainties on electricity price, electricity load and RESs power generation were mitigated through a stochastic analysis using the mean-variance Markowitz theory so that multiple scenarios were analysed before performing the optimal power dispatch. The results demonstrated that day-ahead scheduling and real-time dispatch have more energy surpluses and less shortages for purchasing when including risk hedging parameters.</p>
        <p>In scenario-based stochastic approaches, computational cost is the main concern, because the system's uncertainties are modelled by calculating many possible scenarios. Moreover, they are based on the expected values of the scenario with the highest probability, which does not guarantee that a contingency out of the considered scenarios may occur. In this perspective, robust approaches usually consider the worst-case instead of the most likely scenario to calculate optimal unit commitment and power dispatch in MG. Although robust strategies cannot always guarantee the optimal cost, especially in non-contingency scenarios, in comparison to stochastic methods, it can ensure compliance with security levels as long as achieve comparable MG operation cost [161]. In [40], [162], besides generating multiple scenarios through Mont-Carlo simulation, the conditional value of risk was also considered in the objective function of the economic dispatch to avoid making decisions with a high risk of unprofitably.</p>
        <p>As stated previously, there are many strategies to deal with all the challenges concerning BMGs. For the sake of simplicity, the most usual algorithm for each category presented in Table 7 were compared in Table 8 based on the following five important criteria: I.</p>
        <p>Ability to consider predictions. II.</p>
        <p>Calculation complexity. III.</p>
        <p>Model dependency. IV.</p>
        <p>Flexibility concerning MG expansion. V.</p>
        <p>Robustness against uncertainties.</p>
        <p>Comparison of building energy management systems algorithms</p>
        <p>As depicted in Table 8, metaheuristic algorithms tend to have a low model dependency, and low computation cost in the case of minor MG optimisation, but it can neither consider predictions nor face uncertainties [11]. Although fuzzy logic and other deterministic algorithms have the advantage of being simple when designing the control system since mostly based on empirical system knowledge, they are prone to fail when the system changes or unexpected disturbances occur [36].</p>
        <p>Meanwhile, MPC has been increasingly adopted in the industry due to its simplicity and robustness against external disturbances and changes in the environment. Since it considers past control variables and plant state predictions to forecast MG behaviour and anticipate control actions and only the first sample is applied into the real plant, even with a basic model, the MPC has demonstrated robust and efficient against small disturbances with slight model inaccuracy [40]. Despite not being well-proven yet, since MPC is dependent on mathematical models, its performance can be reduced if the model changes over the years due to the ageing of components or drastic changes in the external environment.</p>
        <p>In this context, Q-learning has emerged as a suitable algorithm to adapt and learn from the environment to improve its algorithm automatically. This can reduce the model's dependency and enhance MG flexibility [159]. However, long-term horizons, such as those used in MPC approaches, are unfeasible due to the exponential increase of state variables. Moreover, another potential drawback of this method is the convergence of time and robustness against drastic changes in the system because the required time to achieve MG efficient point of operation is long or even undetermined in advance. As a result, in the first algorithm's iterations, RL with the scenario generation approach cannot take optimal decisions because of the lack of past information, unless some past data were used to teach the Q-learning agents how to proceed in each situation. Finally, stochastic algorithms face uncertainties in predictions to hedge risks and increase MG benefits. However, this strategy needs high computational resources because of multiple scenario optimisations [120].</p>
        <p>BMGs tend to bring more flexibility to the electrical grid, but bulk changes in both occupant behaviour, electricity operation system and governmental policies are mandatory to boost the future implementation of BMGs. Although many studies were conducted to strive for RES penetration on electricity market throughout BMGs, many concerns must still be addressed in order to bring BMGs into line with the current electricity market and electrical grid standards, notably:</p>
        <p>• dealing with power generation uncertainties • fostering the plug-in-play aspect of BMG devices • defining DR mechanisms to allow BMGs to respond to grid needs • defining the rules of energy exchange between BMGs and the external grid Thanks to technological breakthroughs in communication and IoT devices, real-time data collection has played an important role in dealing with these challenges [111]. Precise data forecasts, scenario generation, and artificialintelligent models based on historical data are promising techniques for designing a BEMS. Algorithms like MPC, reinforcement learning, and stochastic-based algorithms can handle BMG uncertainties and improve the system's robustness. On the other hand, they are heavily dependent on faithful databases to achieve high performance, which can be a serious disadvantage when considering computation costs. Hence, BMGs will tend to be structured around aggregators capable of supporting them with cloud services that offer high computational resources [112].</p>
        <p>The major controversies of data sharing between aggregator and buildings are data privacy and data compatibility, which are not yet well-defined. Particularly, broadcasting weather prediction data among buildings in the same community can be promising, since it is independent on data ownership. However, other building data types are more sensitive concerning cyberattacks, but it has been overcome by advanced cryptography algorithms [88]. Therefore, it is necessary to define which data will be shared, at which rate and under which protocol. Otherwise, it will be difficult to design a BEMS capable of being connected to other buildings and capable of adapting to the constraints of the real system.</p>
        <p>Another barrier faced by BEMS design is the lack of an accurate definition of automated DR programs to allow BMGs to respond continuously to external grid needs. The difficulty of defining DR mechanisms is to achieve a harmonic integration between the main grid and BMGs that is beneficial for both sides [88]. For instance, it is not yet standardised how buildings will be rewarded for offering reactive/active power or for reducing power consumption. This standardisation will only be achieved with synchronism between government policies, communication technology and electricity grid players. However, some designs of future DR programs for buildings exist in the literature. As discussed previously, the raw electricity price's dissemination among BMGs can entail harmful grid instability, leading to the development of other DR variables for improving grid flexibility through DSM, such as load shaping [13][14]. In this context, automatic HVAC controlling and ESS management [77], [166] are promising mechanisms to allow BMGs to be properly rewarded for supporting the external grid. Furthermore, there is a lack of clear rules concerning the energy exchange between buildings and the external grid. The definition of an architecture capable of synchronising multiple buildings inside a grid is still under discussion. The trade-off between peer-to-peer and aggregator structures must be clarified. Peer-to-peer configuration can enhance grid flexibility, but its feasibility in prototypes considering its stability, reliability and its limitation concerning communication delay needs to be evaluated. Most business plans for peer-to-peer BMGs architectures are limited to simulations [67], [129], [167]. On the other hand, energy exchange moderated by a community aggregator is more conservative than peer-to-peer configurations because its operation is like the traditional electricity market but with a smaller capacity. Therefore, experience of traditional electricity markets can be adapted for this new configuration.</p>
        <p>Exploiting BMGs concept in the long term, BMGs are key elements for the next energy system step evolution toward smart energy systems [168], also known as the energy internet, in which intelligent sensing and cloud computing will allow different infrastructure sectors to be interconnected to enhance the overall energy system's efficiency. Combining BMGs, district heating and cooling mechanisms with transportation framework through data sharing and data analysis, the concept of a completely renewable energy system can be envisaged for the near future as concluded in [169]. In [52], [170] proposed a multi-energy market bidding strategy for trading both electricity, natural gas and heat energy, instead of only active and reactive power. In [161], it was proved that with multi-energy conversion, buildings can be more flexible to the grid's needs by implementing peak shifting through energy conversion. In this way, the BEMS have to manage both electrical and thermal storage to match power generation with power consumption. Therefore, future buildings will be both thermal and electric efficient by relying on advanced BEMS algorithms empowered with strong data processing and multiple power exchanges among neighbouring BMGs.</p>
        <p>Dividing the building microgrid controller into hierarchical levels leads to a more robust system, which can reduce the impact of control delays and disturbances. Each control level holds a specific responsibility, but its design depends on the building's size, the microgrid's operating mode (grid-connected or isolated), the architecture of buildings' interconnection with the external grid, and available computation resources. Depending on all these aspects, the energy management system is devised differently. This review paper identifies some directives to assist the building controller's design considering standards, communication protocols, building architectures and types of energy management algorithms. Moreover, in this paper, a comprehensive review of recent studies in hierarchical control for building microgrids is discussed, highlighting the functionalities in each control level as well as the nuances of the electricity market.</p>
        <p>The review indicates the necessity of designing a more flexible energy management system capable of adapting to different configurations. It is necessary to design a hierarchical controller capable of including new microgrid devices easily and adapting to changes in the environment automatically, without needing to restructure the entire controller with exhaustive tests. In this context, algorithms empowered with data processing, such as artificialintelligence approaches, are promising for buildings. Moreover, building energy management systems must be capable of handling the stochastic power generation of renewables by considering data forecasts. Algorithms like predictive control and scenario-based strategies have demonstrated their ability to hedge these risks.</p>
        <p>Many projections about the future of building microgrids have been created, but concrete frameworks for building architectures inside the grid should be established. Details about interoperability among buildings, definition of building communication protocols, and structuration of demand-side management are topics that still opened to research. Based on the literature, there is a tendency for multi-cooperation among buildings inside the same community to achieve marks of self-consumption. This business model can reduce the grid instability and promote the use of renewables, but the definition of economic incentives for grid services offered by building microgrids and contractual bids with other electricity market players are still under development.</p>
        <p>Some important response time for HVAC to BMG to respect building thermal zone standards as ASHRAE, such as estimation of the energy need for heating and cooling. * ISO 52000-1/ ISO 52003-1/ ISO 52010-1/ ISO 52016-1/ ISO 52018-1 Energy performance of buildings Some indicators for assessing the energy performance in buildings. These standards help to define NZEB. * IEEE 2030.7 Energy Management System</p>
        <p>The authors would like to thank the New Aquitaine Region (research agreement: AAPFO424953) and ESTIA, the Institute of Advanced Industrial Technologies, for their financial support for the OptiMicroGrid project.</p>
    </text>
</tei>
